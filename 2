# Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ¥ØµÙ„Ø§Ø­ Ø£ÙŠ Ù…Ø´Ø§ÙƒÙ„
    def _verify_course_statistics(self, course_id):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¯ÙˆØ±Ø© Ù…Ø¹ÙŠÙ†Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„"""
        try:
            cursor = self.db_conn.cursor()

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©
            cursor.execute("SELECT course_code, course_name FROM courses WHERE id = ?", (course_id,))
            course_info = cursor.fetchone()

            if not course_info:
                return

            print(f"\n=== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø© {course_info[0]}: {course_info[1]} ===")

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª
            cursor.execute("""
                SELECT 
                    participant_status, 
                    COUNT(*) as count,
                    GROUP_CONCAT(participant_name, ', ') as names
                FROM participants 
                WHERE course_id = ?
                GROUP BY participant_status
            """, (course_id,))

            status_details = cursor.fetchall()

            total = 0
            passed = 0
            not_passed = 0

            print("ØªÙØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª:")
            for status, count, names in status_details:
                print(f"  - {status}: {count} Ù…Ø´Ø§Ø±Ùƒ")
                # print(f"    Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: {names[:100]}..." if len(names) > 100 else f"    Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: {names}")

                total += count

                # ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø§Øª
                if status in ['Ù…Ø¬ØªØ§Ø²', 'Ø¨Ø§Ø´Ø±']:
                    passed += count
                else:
                    not_passed += count

            print(f"\nØ§Ù„Ù…Ù„Ø®Øµ:")
            print(f"  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {total}")
            print(f"  Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†: {passed}")
            print(f"  ØºÙŠØ± Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†: {not_passed}")
            print("=" * 50)

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: {e}")

    # Ø¯Ø§Ù„Ø© Ù„Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
    def _fix_participant_statuses(self):
        """Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ØºÙŠØ± Ø§Ù„ØµØ­ÙŠØ­Ø©"""
        try:
            cursor = self.db_conn.cursor()

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
            cursor.execute("SELECT DISTINCT participant_status FROM participants")
            statuses = cursor.fetchall()

            print("Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:")
            for status in statuses:
                if status[0]:
                    print(f"  - '{status[0]}'")

            # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
            fixes = [
                # ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© Ø®Ø·Ø£
                (
                    "UPDATE participants SET participant_status = 'Ù…Ø¬ØªØ§Ø²' WHERE participant_status IN ('Ù…Ø¬ØªØ§Ø² ', ' Ù…Ø¬ØªØ§Ø²', 'ï»£ïº ïº˜ïºïº¯')",
                    'Ù…Ø¬ØªØ§Ø²'),
                (
                    "UPDATE participants SET participant_status = 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' WHERE participant_status IN ('Ù„Ù… ÙŠØ¨Ø§Ø´Ø± ', ' Ù„Ù… ÙŠØ¨Ø§Ø´Ø±', 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø± Ø§Ù„Ø¯ÙˆØ±Ø©')",
                    'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±'),
                (
                    "UPDATE participants SET participant_status = 'Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©' WHERE participant_status IN ('Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø© ', ' Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©', 'Ø§Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©', 'Ø¥Ù„ØºØ§Ø¡')",
                    'Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©'),
                (
                    "UPDATE participants SET participant_status = 'Ù…Ø±ÙÙˆØ¶ Ø£Ø®Ø±Ù‰' WHERE participant_status IN ('Ù…Ø±ÙÙˆØ¶', 'Ø£Ø®Ø±Ù‰', 'Ù…Ø±ÙÙˆØ¶ Ø§Ø®Ø±Ù‰')",
                    'Ù…Ø±ÙÙˆØ¶ Ø£Ø®Ø±Ù‰'),

                # ØªØµØ­ÙŠØ­ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ NULL
                (
                    "UPDATE participants SET participant_status = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' WHERE participant_status IS NULL OR participant_status = ''",
                    'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'),
            ]

            total_fixed = 0
            for query, status_name in fixes:
                cursor.execute(query)
                fixed_count = cursor.rowcount
                if fixed_count > 0:
                    print(f"ØªÙ… Ø¥ØµÙ„Ø§Ø­ {fixed_count} Ø³Ø¬Ù„ Ù„Ù„Ø­Ø§Ù„Ø© '{status_name}'")
                    total_fixed += fixed_count

            if total_fixed > 0:
                self.db_conn.commit()
                print(f"\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø­Ø©: {total_fixed}")
                messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø¥ØµÙ„Ø§Ø­ {total_fixed} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­")
            else:
                print("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­")

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø§Ù„Ø§Øª: {e}")
            self.db_conn.rollback()

    def _add_new_course(self):
        """Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©"""
        add_window = tk.Toplevel(self)
        add_window.title("Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©")
        add_window.state('zoomed')  # Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
        add_window.configure(bg=self.COLORS["background"])
        add_window.transient(self)
        add_window.grab_set()

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        header = tk.Frame(add_window, bg="#1E3A5F", height=100)
        header.pack(fill=tk.X)
        header.pack_propagate(False)

        header_content = tk.Frame(header, bg="#1E3A5F")
        header_content.pack(expand=True, fill=tk.BOTH)

        tk.Label(
            header_content,
            text="Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©",
            font=("Tajawal", 32, "bold"),
            bg="#1E3A5F",
            fg="white"
        ).pack(expand=True)

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_btn = tk.Button(
            header_content,
            text="âœ• Ø¥ØºÙ„Ø§Ù‚",
            font=self.FONTS["text_bold"],
            bg="#dc3545",
            fg="white",
            padx=20,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=add_window.destroy
        )
        close_btn.place(relx=0.95, rely=0.5, anchor="e")

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_container = tk.Frame(add_window, bg=self.COLORS["background"])
        main_container.pack(fill=tk.BOTH, expand=True, padx=50, pady=30)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        input_frame = tk.Frame(main_container, bg=self.COLORS["card"], padx=40, pady=30)
        input_frame.pack(fill=tk.BOTH, expand=True)

        # ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ ØµÙÙŠÙ†
        left_frame = tk.Frame(input_frame, bg=self.COLORS["card"])
        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 20))

        right_frame = tk.Frame(input_frame, bg=self.COLORS["card"])
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(20, 0))

        # === Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± ===

        # 1. Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            left_frame,
            text="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        course_name_entry = tk.Entry(
            left_frame,
            font=self.FONTS["body"],
            bd=1,
            relief=tk.SOLID,
            bg="white"
        )
        course_name_entry.pack(fill=tk.X, pady=(0, 20), ipady=8)

        # 2. Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            left_frame,
            text="Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        course_code_entry = tk.Entry(
            left_frame,
            font=self.FONTS["body"],
            bd=1,
            relief=tk.SOLID,
            bg="white"
        )
        course_code_entry.pack(fill=tk.X, pady=(0, 20), ipady=8)

        # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        def validate_number(char):
            return char.isdigit() or char == ""

        vcmd = (add_window.register(validate_number), '%P')
        course_code_entry.config(validate='key', validatecommand=vcmd)

        # 3. ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            left_frame,
            text="ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        categories = ["Ø¶Ø¨Ø§Ø·", "Ø£ÙØ±Ø§Ø¯", "Ù…Ø´ØªØ±ÙƒØ©", "Ù…Ø¯Ù†ÙŠÙŠÙ†", "Ø·Ø§Ù„Ø¨ Ø¹Ø³ÙƒØ±ÙŠ"]
        category_var = tk.StringVar(add_window)
        category_combo = ttk.Combobox(
            left_frame,
            textvariable=category_var,
            values=categories,
            font=self.FONTS["body"],
            state="readonly"
        )
        category_combo.pack(fill=tk.X, pady=(0, 20), ipady=5)
        category_combo.current(0)

        # 4. ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            left_frame,
            text="ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        # Ø§Ø³ØªØ®Ø¯Ø§Ù… DateEntry Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Entry Ø¹Ø§Ø¯ÙŠ
        try:
            from tkcalendar import DateEntry
            start_date_entry = DateEntry(
                left_frame,
                font=self.FONTS["body"],
                date_pattern='yyyy-mm-dd',
                width=20,
                background=self.COLORS["primary"],
                foreground='white',
                borderwidth=2
            )
            start_date_entry.pack(fill=tk.X, pady=(0, 20), ipady=5)
        except ImportError:
            start_date_frame = tk.Frame(left_frame, bg=self.COLORS["card"])
            start_date_frame.pack(fill=tk.X, pady=(0, 20))

            start_date_entry = tk.Entry(
                start_date_frame,
                font=self.FONTS["body"],
                bd=1,
                relief=tk.SOLID,
                bg="white"
            )
            start_date_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, ipady=8)
            start_date_entry.insert(0, datetime.datetime.now().strftime("%Y-%m-%d"))

            tk.Label(
                start_date_frame,
                text="(YYYY-MM-DD)",
                font=self.FONTS["small"],
                bg=self.COLORS["card"],
                fg="#666"
            ).pack(side=tk.RIGHT, padx=(10, 0))

        # === Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† ===

        # 5. ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            right_frame,
            text="ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        try:
            from tkcalendar import DateEntry
            end_date_entry = DateEntry(
                right_frame,
                font=self.FONTS["body"],
                date_pattern='yyyy-mm-dd',
                width=20,
                background=self.COLORS["primary"],
                foreground='white',
                borderwidth=2
            )
            end_date_entry.pack(fill=tk.X, pady=(0, 20), ipady=5)
        except ImportError:
            end_date_frame = tk.Frame(right_frame, bg=self.COLORS["card"])
            end_date_frame.pack(fill=tk.X, pady=(0, 20))

            end_date_entry = tk.Entry(
                end_date_frame,
                font=self.FONTS["body"],
                bd=1,
                relief=tk.SOLID,
                bg="white"
            )
            end_date_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, ipady=8)
            end_date_entry.insert(0, datetime.datetime.now().strftime("%Y-%m-%d"))

            tk.Label(
                end_date_frame,
                text="(YYYY-MM-DD)",
                font=self.FONTS["small"],
                bg=self.COLORS["card"],
                fg="#666"
            ).pack(side=tk.RIGHT, padx=(10, 0))

        # 6. Ø§Ù„Ø¬Ù†Ø³
        tk.Label(
            right_frame,
            text="Ø§Ù„Ø¬Ù†Ø³:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        gender_frame = tk.Frame(right_frame, bg=self.COLORS["card"])
        gender_frame.pack(fill=tk.X, pady=(0, 20))

        gender_var = tk.StringVar(add_window, value="Ø°ÙƒØ±")

        male_radio = tk.Radiobutton(
            gender_frame,
            text="Ø°ÙƒØ±",
            variable=gender_var,
            value="Ø°ÙƒØ±",
            font=self.FONTS["text"],
            bg=self.COLORS["card"]
        )
        male_radio.pack(side=tk.LEFT, padx=(0, 30))

        female_radio = tk.Radiobutton(
            gender_frame,
            text="Ø£Ù†Ø«Ù‰",
            variable=gender_var,
            value="Ø£Ù†Ø«Ù‰",
            font=self.FONTS["text"],
            bg=self.COLORS["card"]
        )
        female_radio.pack(side=tk.LEFT)

        # 7. Ø§Ø´ØªØ±Ø§Ø·Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            right_frame,
            text="Ø§Ø´ØªØ±Ø§Ø·Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["card"],
            fg=self.COLORS["on_surface"]
        ).pack(anchor="w", pady=(0, 5))

        requirements_frame = tk.Frame(right_frame, bg=self.COLORS["card"])
        requirements_frame.pack(fill=tk.X, pady=(0, 20))

        requirements_var = tk.StringVar(add_window, value="ØªÙØ±Øº")

        fulltime_radio = tk.Radiobutton(
            requirements_frame,
            text="ØªÙØ±Øº",
            variable=requirements_var,
            value="ØªÙØ±Øº",
            font=self.FONTS["text"],
            bg=self.COLORS["card"]
        )
        fulltime_radio.pack(side=tk.LEFT, padx=(0, 30))

        parttime_radio = tk.Radiobutton(
            requirements_frame,
            text="Ø¨Ø¯ÙˆÙ† ØªÙØ±Øº",
            variable=requirements_var,
            value="Ø¨Ø¯ÙˆÙ† ØªÙØ±Øº",
            font=self.FONTS["text"],
            bg=self.COLORS["card"]
        )
        parttime_radio.pack(side=tk.LEFT)

        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        buttons_frame = tk.Frame(main_container, bg=self.COLORS["background"], pady=20)
        buttons_frame.pack(fill=tk.X)

        def save_course():
            # Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            name = course_name_entry.get().strip()
            code = course_code_entry.get().strip()
            category = category_var.get()
            gender = gender_var.get()
            requirements = requirements_var.get()

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            try:
                # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† DateEntry
                start_date = start_date_entry.get_date().strftime("%Y-%m-%d")
                end_date = end_date_entry.get_date().strftime("%Y-%m-%d")
            except:
                # Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† Entry Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                start_date = start_date_entry.get().strip()
                end_date = end_date_entry.get().strip()

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if not name or not code:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ±Ù‚Ù…Ù‡Ø§")
                return

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
            cursor = self.db_conn.cursor()
            cursor.execute("SELECT COUNT(*) FROM courses WHERE course_code=?", (code,))
            if cursor.fetchone()[0] > 0:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
                return

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
            try:
                start_dt = datetime.datetime.strptime(start_date, "%Y-%m-%d")
                end_dt = datetime.datetime.strptime(end_date, "%Y-%m-%d")

                if end_dt < start_dt:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©")
                    return
            except ValueError:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©")
                return

            # Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±Ø©
            try:
                with self.db_conn:
                    self.db_conn.execute("""
                        INSERT INTO courses (
                            course_code, course_name, course_category, start_date, 
                            end_date, gender, requirements, status, created_date, created_by
                        ) VALUES (?, ?, ?, ?, ?, ?, ?, 'Ø¬Ø§Ø±ÙŠØ©', ?, ?)
                    """, (
                        code, name, category, start_date, end_date, gender, requirements,
                        datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        self.current_user["full_name"] if self.current_user else "Ø§Ù„Ù†Ø¸Ø§Ù…"
                    ))

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­")
                self._load_courses()
                add_window.destroy()

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

        save_btn = tk.Button(
            buttons_frame,
            text="Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ±Ø©",
            font=("Tajawal", 16, "bold"),
            bg=self.COLORS["success"],
            fg="white",
            padx=40,
            pady=15,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=save_course
        )
        save_btn.pack(side=tk.LEFT, padx=10)

        cancel_btn = tk.Button(
            buttons_frame,
            text="Ø¥Ù„ØºØ§Ø¡",
            font=("Tajawal", 16, "bold"),
            bg=self.COLORS["danger"],
            fg="white",
            padx=40,
            pady=15,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=add_window.destroy
        )
        cancel_btn.pack(side=tk.RIGHT, padx=10)

    def _edit_course(self):
        """ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"""
        selected = self.courses_tree.selection()
        if not selected:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„")
            return

        # TODO: ØªÙ†ÙÙŠØ° ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©
        messagebox.showinfo("Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±", "ÙˆØ¸ÙŠÙØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±")

    def _delete_course(self):
        """Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"""
        selected = self.courses_tree.selection()
        if not selected:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±Ø© Ù„Ù„Ø­Ø°Ù")
            return

        item = self.courses_tree.item(selected[0])
        course_data = item["values"]
        course_code = course_data[0]
        course_name = course_data[1]

        if messagebox.askyesno("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù", f"Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø© '{course_name}'ØŸ"):
            try:
                cursor = self.db_conn.cursor()
                cursor.execute("SELECT id FROM courses WHERE course_code=?", (course_code,))
                result = cursor.fetchone()
                if result:
                    course_id = result[0]

                    with self.db_conn:
                        # Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
                        self.db_conn.execute("DELETE FROM participants WHERE course_id=?", (course_id,))
                        # Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø©
                        self.db_conn.execute("DELETE FROM courses WHERE id=?", (course_id,))

                    messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­")
                    self._load_courses()

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

    def _on_course_double_click(self, event):
        """Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ø¹Ù„Ù‰ Ø¯ÙˆØ±Ø©"""
        selected = self.courses_tree.selection()
        if not selected:
            return

        item = self.courses_tree.item(selected[0])
        course_data = item["values"]
        course_code = course_data[0]
        course_name = course_data[1]

        # ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©
        self._show_course_details(course_code, course_name)

    def _show_course_details(self, course_code, course_name):
        """Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨ØªØµÙ…ÙŠÙ… Ø±Ø³Ù…ÙŠ Ù…Ø­Ø³Ù†"""
        details_window = tk.Toplevel(self)
        details_window.title(f"ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©: {course_name}")
        details_window.state('zoomed')
        details_window.configure(bg="#F5F5F5")
        details_window.transient(self)
        details_window.grab_set()

        # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙÙ‡Ø±Ø³Ø© ÙˆØ§Ù„Ø¨Ø­Ø«
        participants_per_page = 100
        current_page = 1
        total_pages = 1
        search_text = ""

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©
        cursor = self.db_conn.cursor()
        cursor.execute("""
            SELECT id, course_name, course_code, course_category, 
                   start_date, end_date, gender, requirements, location, 
                   trainer, total_participants, status
            FROM courses 
            WHERE course_code=?
        """, (course_code,))
        course_info = cursor.fetchone()

        if course_info:
            course_id = course_info[0]
            course_category = course_info[3] if course_info[3] else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"

            # Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            cursor.execute("""
                SELECT 
                    COUNT(*) as total,
                    SUM(CASE WHEN participant_status IN ('Ù…Ø¬ØªØ§Ø²', 'Ø¨Ø§Ø´Ø±') THEN 1 ELSE 0 END) as passed,
                    SUM(CASE WHEN participant_status = 'Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©' THEN 1 ELSE 0 END) as cancelled,
                    SUM(CASE WHEN participant_status = 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' THEN 1 ELSE 0 END) as not_started
                FROM participants 
                WHERE course_id=?
            """, (course_id,))

            stats = cursor.fetchone()

        # ================== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨ØªØµÙ…ÙŠÙ… Ø±Ø³Ù…ÙŠ ==================
        header = tk.Frame(details_window, bg="#2c3e50", height=100)
        header.pack(fill=tk.X)
        header.pack_propagate(False)

        header_content = tk.Frame(header, bg="#2c3e50")
        header_content.pack(expand=True, fill=tk.BOTH)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
        title_frame = tk.Frame(header_content, bg="#2c3e50")
        title_frame.pack(expand=True)

        tk.Label(
            title_frame,
            text=f"{course_name}",
            font=("Tajawal", 24, "bold"),
            bg="#2c3e50",
            fg="white"
        ).pack()

        tk.Label(
            title_frame,
            text=f"Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©: {course_code}  |  Ø§Ù„ÙØ¦Ø©: {course_category}",
            font=("Tajawal", 14),
            bg="#2c3e50",
            fg="#ecf0f1"
        ).pack(pady=(5, 0))

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_btn = tk.Button(
            header_content,
            text="âœ• Ø¥ØºÙ„Ø§Ù‚",
            font=("Tajawal", 12, "bold"),
            bg="#c0392b",
            fg="white",
            padx=20,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=details_window.destroy
        )
        close_btn.place(relx=0.95, rely=0.5, anchor="e")

        # ================== Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==================
        main_content = tk.Frame(details_window, bg="#F5F5F5")
        main_content.pack(fill=tk.BOTH, expand=True, padx=15, pady=10)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        buttons_frame = tk.Frame(main_content, bg="#F5F5F5")
        buttons_frame.pack(fill=tk.X, pady=(0, 10))

        # Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        edit_status_btn = tk.Button(
            buttons_frame,
            text="âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†",
            font=("Tajawal", 12, "bold"),
            bg="#34495e",
            fg="white",
            padx=25,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._edit_participant_status(course_id, course_name, details_window)
        )
        edit_status_btn.pack(side=tk.LEFT, padx=5)

        # Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        import_btn = tk.Button(
            buttons_frame,
            text="ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel",
            font=("Tajawal", 12, "bold"),
            bg="#34495e",
            fg="white",
            padx=25,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._import_participants_for_course(course_id, course_name)
        )
        import_btn.pack(side=tk.LEFT, padx=5)

        # ================== Ø¥Ø·Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¨Ø­Ø« ==================
        stats_search_frame = tk.Frame(main_content, bg="white", relief=tk.RAISED, bd=1)
        stats_search_frame.pack(fill=tk.X, pady=(0, 10))

        # Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        stats_section = tk.Frame(stats_search_frame, bg="white", pady=15)
        stats_section.pack(fill=tk.X)

        # Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
        cards_container = tk.Frame(stats_section, bg="white")
        cards_container.pack()

        # Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        total_card = tk.Frame(cards_container, bg="#ecf0f1", relief=tk.FLAT, bd=1, width=150, height=80)
        total_card.pack(side=tk.LEFT, padx=10)
        total_card.pack_propagate(False)

        tk.Label(
            total_card,
            text="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†",
            font=("Tajawal", 11),
            bg="#ecf0f1",
            fg="#2c3e50"
        ).pack(pady=(10, 5))

        tk.Label(
            total_card,
            text=str(stats[0] if stats[0] else 0),
            font=("Tajawal", 24, "bold"),
            bg="#ecf0f1",
            fg="#34495e"
        ).pack()

        # Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†
        passed_card = tk.Frame(cards_container, bg="#d5f4e6", relief=tk.FLAT, bd=1, width=150, height=80)
        passed_card.pack(side=tk.LEFT, padx=10)
        passed_card.pack_propagate(False)

        tk.Label(
            passed_card,
            text="Ù…Ø¬ØªØ§Ø²",
            font=("Tajawal", 11),
            bg="#d5f4e6",
            fg="#27ae60"
        ).pack(pady=(10, 5))

        tk.Label(
            passed_card,
            text=str(stats[1] if stats[1] else 0),
            font=("Tajawal", 24, "bold"),
            bg="#d5f4e6",
            fg="#229954"
        ).pack()

        # Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©
        cancelled_card = tk.Frame(cards_container, bg="#fadbd8", relief=tk.FLAT, bd=1, width=150, height=80)
        cancelled_card.pack(side=tk.LEFT, padx=10)
        cancelled_card.pack_propagate(False)

        tk.Label(
            cancelled_card,
            text="Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©",
            font=("Tajawal", 11),
            bg="#fadbd8",
            fg="#e74c3c"
        ).pack(pady=(10, 5))

        tk.Label(
            cancelled_card,
            text=str(stats[2] if stats[2] else 0),
            font=("Tajawal", 24, "bold"),
            bg="#fadbd8",
            fg="#c0392b"
        ).pack()

        # Ø¨Ø·Ø§Ù‚Ø© Ù„Ù… ÙŠØ¨Ø§Ø´Ø±
        not_started_card = tk.Frame(cards_container, bg="#fdebd0", relief=tk.FLAT, bd=1, width=150, height=80)
        not_started_card.pack(side=tk.LEFT, padx=10)
        not_started_card.pack_propagate(False)

        tk.Label(
            not_started_card,
            text="Ù„Ù… ÙŠØ¨Ø§Ø´Ø±",
            font=("Tajawal", 11),
            bg="#fdebd0",
            fg="#e67e22"
        ).pack(pady=(10, 5))

        tk.Label(
            not_started_card,
            text=str(stats[3] if stats[3] else 0),
            font=("Tajawal", 24, "bold"),
            bg="#fdebd0",
            fg="#d35400"
        ).pack()

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(stats_search_frame, bg="#E0E0E0", height=1)
        separator.pack(fill=tk.X, padx=30, pady=5)

        # Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø«
        search_section = tk.Frame(stats_search_frame, bg="white", padx=30, pady=10)
        search_section.pack(fill=tk.X)

        search_row = tk.Frame(search_section, bg="white")
        search_row.pack()

        tk.Label(
            search_row,
            text="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†:",
            font=("Tajawal", 13, "bold"),
            bg="white",
            fg="#2c3e50"
        ).pack(side=tk.LEFT, padx=(0, 10))

        search_entry = tk.Entry(
            search_row,
            font=("Tajawal", 12),
            width=35,
            bd=2,
            relief=tk.GROOVE
        )
        search_entry.pack(side=tk.LEFT, padx=(0, 10))

        def search_participants():
            nonlocal search_text, current_page
            search_text = search_entry.get().strip()
            current_page = 1
            refresh_participants()

        search_btn = tk.Button(
            search_row,
            text="Ø¨Ø­Ø«",
            font=("Tajawal", 11, "bold"),
            bg="#3498db",
            fg="white",
            padx=25,
            pady=6,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=search_participants
        )
        search_btn.pack(side=tk.LEFT, padx=5)

        clear_btn = tk.Button(
            search_row,
            text="Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙƒÙ„",
            font=("Tajawal", 11, "bold"),
            bg="#7f8c8d",
            fg="white",
            padx=25,
            pady=6,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: clear_search()
        )
        clear_btn.pack(side=tk.LEFT, padx=5)

        # Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        results_label = tk.Label(
            search_row,
            text="",
            font=("Tajawal", 11, "bold"),
            bg="white",
            fg="#27ae60"
        )
        results_label.pack(side=tk.LEFT, padx=20)

        def clear_search():
            search_entry.delete(0, tk.END)
            nonlocal search_text, current_page
            search_text = ""
            current_page = 1
            refresh_participants()

        search_entry.bind('<Return>', lambda e: search_participants())

        # ================== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù…Ø¹ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø­Ø¯Ø¯ ==================
        table_main_frame = tk.Frame(main_content, bg="white", relief=tk.RAISED, bd=1, height=400)
        table_main_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 5))
        table_main_frame.pack_propagate(False)  # Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

        # Ø´Ø±ÙŠØ· Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table_header = tk.Frame(table_main_frame, bg="#34495e", height=40)
        table_header.pack(fill=tk.X)
        table_header.pack_propagate(False)

        table_title_label = tk.Label(
            table_header,
            text="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†",
            font=("Tajawal", 13, "bold"),
            bg="#34495e",
            fg="white"
        )
        table_title_label.pack(expand=True)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table_container = tk.Frame(table_main_frame, bg="white")
        table_container.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        columns = ("Ø§Ù„Ø¥Ø³Ù…", "Ø§Ù„Ø±ØªØ¨Ø©", "Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø¬Ù‡Ø©", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„Ø³Ø¨Ø¨")

        participants_tree = ttk.Treeview(table_container, columns=columns, show="headings", height=10)

        participants_tree.column("Ø§Ù„Ø¥Ø³Ù…", width=220, anchor="center")
        participants_tree.column("Ø§Ù„Ø±ØªØ¨Ø©", width=100, anchor="center")
        participants_tree.column("Ø§Ù„Ù‡ÙˆÙŠØ©", width=130, anchor="center")
        participants_tree.column("Ø§Ù„Ø¬Ù‡Ø©", width=200, anchor="center")
        participants_tree.column("Ø§Ù„Ø­Ø§Ù„Ø©", width=110, anchor="center")
        participants_tree.column("Ø§Ù„Ø³Ø¨Ø¨", width=280, anchor="center")

        style = ttk.Style()
        style.configure("Treeview.Heading", font=("Tajawal", 12, "bold"))
        style.configure("Treeview", font=("Tajawal", 11), rowheight=28)

        for col in columns:
            participants_tree.heading(col, text=col)

        scrollbar = ttk.Scrollbar(table_container, orient="vertical", command=participants_tree.yview)
        participants_tree.configure(yscrollcommand=scrollbar.set)

        participants_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        participants_tree.tag_configure("passed", background="#d5f4e6")
        participants_tree.tag_configure("cancelled", background="#fadbd8")
        participants_tree.tag_configure("not_started", background="#fdebd0")

        # ================== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ ==================
        nav_frame = tk.Frame(table_main_frame, bg="#ecf0f1", height=45)
        nav_frame.pack(fill=tk.X, side=tk.BOTTOM)
        nav_frame.pack_propagate(False)

        nav_content = tk.Frame(nav_frame, bg="#ecf0f1")
        nav_content.pack(expand=True, pady=8)

        prev_btn = tk.Button(
            nav_content,
            text="â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚",
            font=("Tajawal", 11, "bold"),
            bg="#34495e",
            fg="white",
            padx=20,
            pady=5,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            state=tk.DISABLED,
            command=lambda: navigate_page(-1)
        )
        prev_btn.pack(side=tk.LEFT, padx=10)

        page_label = tk.Label(
            nav_content,
            text="Ø§Ù„ØµÙØ­Ø© 1 Ù…Ù† 1",
            font=("Tajawal", 12, "bold"),
            bg="#ecf0f1",
            fg="#2c3e50"
        )
        page_label.pack(side=tk.LEFT, padx=20)

        next_btn = tk.Button(
            nav_content,
            text="Ø§Ù„ØªØ§Ù„ÙŠ â–¶",
            font=("Tajawal", 11, "bold"),
            bg="#34495e",
            fg="white",
            padx=20,
            pady=5,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: navigate_page(1)
        )
        next_btn.pack(side=tk.LEFT, padx=10)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø¯Ø¯
        count_label = tk.Label(
            nav_content,
            text="",
            font=("Tajawal", 10),
            bg="#ecf0f1",
            fg="#7f8c8d"
        )
        count_label.pack(side=tk.RIGHT, padx=20)

        def navigate_page(direction):
            nonlocal current_page
            new_page = current_page + direction
            if 1 <= new_page <= total_pages:
                current_page = new_page
                refresh_participants()

        def refresh_participants():
            nonlocal total_pages

            # Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            for item in participants_tree.get_children():
                participants_tree.delete(item)

            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            if search_text:
                cursor.execute("""
                    SELECT COUNT(*) FROM participants 
                    WHERE course_id = ? AND (
                        participant_name LIKE ? OR 
                        national_id LIKE ? OR
                        department LIKE ?
                    )
                """, (course_id, f"%{search_text}%", f"%{search_text}%", f"%{search_text}%"))
            else:
                cursor.execute("""
                    SELECT COUNT(*) FROM participants 
                    WHERE course_id = ?
                """, (course_id,))

            total_participants = cursor.fetchone()[0]
            total_pages = max(1, (total_participants + participants_per_page - 1) // participants_per_page)

            offset = (current_page - 1) * participants_per_page

            # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            if search_text:
                cursor.execute("""
                    SELECT participant_name, rank, national_id, department,
                           participant_status, cancellation_reason
                    FROM participants 
                    WHERE course_id = ? AND (
                        participant_name LIKE ? OR 
                        national_id LIKE ? OR
                        department LIKE ?
                    )
                    ORDER BY participant_name
                    LIMIT ? OFFSET ?
                """, (course_id, f"%{search_text}%", f"%{search_text}%", f"%{search_text}%",
                      participants_per_page, offset))
            else:
                cursor.execute("""
                    SELECT participant_name, rank, national_id, department,
                           participant_status, cancellation_reason
                    FROM participants 
                    WHERE course_id = ?
                    ORDER BY participant_name
                    LIMIT ? OFFSET ?
                """, (course_id, participants_per_page, offset))

            participants = cursor.fetchall()

            if not participants and search_text:
                participants_tree.insert("", tk.END, values=(
                    f"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: {search_text}", "", "", "", "", ""
                ))
                results_label.config(text="Ø§Ù„Ù†ØªØ§Ø¦Ø¬: 0", fg="#e74c3c")
            else:
                for row in participants:
                    tag = ""
                    if row[4] in ["Ù…Ø¬ØªØ§Ø²", "Ø¨Ø§Ø´Ø±"]:
                        tag = "passed"
                    elif row[4] == "Ø¥Ù„ØºØ§Ø¡ Ø¯ÙˆØ±Ø©":
                        tag = "cancelled"
                    elif row[4] == "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±":
                        tag = "not_started"

                    participants_tree.insert("", tk.END, values=row, tags=(tag,))

                if search_text:
                    results_label.config(text=f"Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {total_participants}", fg="#27ae60")
                else:
                    results_label.config(text="")

            # ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø©
            page_label.config(text=f"Ø§Ù„ØµÙØ­Ø© {current_page} Ù…Ù† {total_pages}")

            # ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø¯Ø¯
            start_num = offset + 1 if total_participants > 0 else 0
            end_num = min(offset + participants_per_page, total_participants)
            count_label.config(text=f"Ø¹Ø±Ø¶ {start_num}-{end_num} Ù…Ù† {total_participants}")

            if search_text:
                table_title_label.config(text=f"Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« ({total_participants} Ù…Ø´Ø§Ø±Ùƒ)")
            else:
                table_title_label.config(text=f"Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ({total_participants})")

            # ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            prev_btn.config(state=tk.NORMAL if current_page > 1 else tk.DISABLED)
            next_btn.config(state=tk.NORMAL if current_page < total_pages else tk.DISABLED)

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        refresh_participants()

    def _create_footer(self):
        """Ø´Ø±ÙŠØ· Ø³ÙÙ„ÙŠ Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø£ØµÙ„ÙŠ"""
        footer = tk.Frame(self, bg="#2c3e50", height=50)
        footer.pack(side=tk.BOTTOM, fill=tk.X)
        footer.pack_propagate(False)

        # Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        left_frame = tk.Frame(footer, bg="#2c3e50")
        left_frame.pack(side=tk.LEFT, padx=20, pady=8)

        user_icon = tk.Label(
            left_frame,
            text="ğŸ‘¤",
            font=("Arial", 16),
            bg="#2c3e50",
            fg="white"
        )
        user_icon.pack(side=tk.LEFT, padx=(0, 10))

        user_name = tk.Label(
            left_frame,
            text=f"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {self.current_user['full_name']}" if self.current_user else "ØºÙŠØ± Ù…Ø¹Ø±Ù",
            font=self.FONTS["text_bold"],
            bg="#2c3e50",
            fg="white"
        )
        user_name.pack(side=tk.LEFT)

        # Ø§Ù„ÙˆØ³Ø· - Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…
        center_frame = tk.Frame(footer, bg="#2c3e50")
        center_frame.pack(side=tk.LEFT, expand=True, padx=20)

        status_text = tk.Label(
            center_frame,
            text="Ù†Ø¸Ø§Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª",
            font=self.FONTS["title"],
            bg="#2c3e50",
            fg="white"
        )
        status_text.pack(side=tk.LEFT)

        # Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† - Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
        right_frame = tk.Frame(footer, bg="#2c3e50")
        right_frame.pack(side=tk.RIGHT, padx=20, pady=8)

        logout_btn = tk.Button(
            right_frame,
            text="âš¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
            font=self.FONTS["text_bold"],
            bg="#e74c3c",
            fg="white",
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            padx=20,
            pady=8,
            command=self._logout
        )
        logout_btn.pack(side=tk.RIGHT)

        # ØªØ£Ø«ÙŠØ± hover
        def on_enter(e):
            logout_btn['bg'] = '#c0392b'

        def on_leave(e):
            logout_btn['bg'] = '#e74c3c'

        logout_btn.bind("<Enter>", on_enter)
        logout_btn.bind("<Leave>", on_leave)

    def _on_closing(self):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©"""
        if messagebox.askokcancel("Ø¥ØºÙ„Ø§Ù‚", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ"):
            try:
                if hasattr(self, 'db_conn') and self.db_conn:
                    self.db_conn.close()
            except:
                pass
            finally:
                self.quit()
                self.destroy()
                import sys
                sys.exit(0)

    def _open_audit_validation(self):
        """ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©"""

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
        audit_window = tk.Toplevel(self)
        audit_window.title("Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©")
        audit_window.state('zoomed')
        audit_window.configure(bg="#f0f2f5")
        audit_window.transient(self)
        audit_window.grab_set()

        # ================== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø«Ø§Ø¨Øª) ==================
        header = tk.Frame(audit_window, bg="#1a237e", height=100)
        header.pack(fill=tk.X)
        header.pack_propagate(False)

        # Ø´Ø¹Ø§Ø± Ø£Ùˆ Ø£ÙŠÙ‚ÙˆÙ†Ø©
        logo_frame = tk.Frame(header, bg="#1a237e")
        logo_frame.pack(side=tk.RIGHT, padx=30, pady=20)

        tk.Label(
            logo_frame,
            text="ğŸ“Š",
            font=("Arial", 36),
            bg="#1a237e",
            fg="white"
        ).pack()

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø£Ø³
        header_info = tk.Frame(header, bg="#1a237e")
        header_info.pack(side=tk.RIGHT, padx=20, pady=25)

        tk.Label(
            header_info,
            text="Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„",
            font=("Tajawal", 24, "bold"),
            bg="#1a237e",
            fg="white"
        ).pack(anchor="w")

        tk.Label(
            header_info,
            text="Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Øª â€¢ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†",
            font=("Tajawal", 12),
            bg="#1a237e",
            fg="#b3b9ff"
        ).pack(anchor="w")

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ
        close_frame = tk.Frame(header, bg="#1a237e")
        close_frame.pack(side=tk.LEFT, padx=20)

        close_btn = tk.Button(
            close_frame,
            text="âœ•",
            font=("Arial", 18),
            bg="#ff5252",
            fg="white",
            width=3,
            height=1,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=audit_window.destroy
        )
        close_btn.pack(pady=25)

        # ================== Ø¥Ø·Ø§Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==================
        from tkinter import ttk

        main_canvas = tk.Canvas(audit_window, bg="#f0f2f5", highlightthickness=0)
        main_scrollbar_y = ttk.Scrollbar(audit_window, orient="vertical", command=main_canvas.yview)

        scrollable_frame = tk.Frame(main_canvas, bg="#f0f2f5")

        scrollable_frame.bind(
            "<Configure>",
            lambda e: main_canvas.configure(scrollregion=main_canvas.bbox("all"))
        )

        main_canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        main_canvas.configure(yscrollcommand=main_scrollbar_y.set)

        def on_mousewheel(event):
            try:
                widget = event.widget
                if widget and hasattr(widget, 'winfo_exists') and widget.winfo_exists():
                    if isinstance(widget, tk.Canvas) or widget.winfo_class() == 'Canvas':
                        widget.yview_scroll(int(-1 * (event.delta / 120)), "units")
            except:
                pass

        audit_window.bind_all("<MouseWheel>", on_mousewheel)

        # ================== Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ==================
        main_container = tk.Frame(scrollable_frame, bg="#f0f2f5")
        main_container.pack(fill=tk.BOTH, expand=True, padx=30, pady=20)

        # ================== Ø¥Ù†Ø´Ø§Ø¡ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø±Ø¦ÙŠØ³ÙŠØ© ==================
        main_tab_control = ttk.Notebook(main_container)
        main_tab_control.pack(fill=tk.BOTH, expand=True)

        style = ttk.Style()
        style.theme_use('clam')

        # ØªØ®ØµÙŠØµ Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        style.configure('TNotebook', background='#f0f2f5', borderwidth=0)
        style.configure('TNotebook.Tab',
                        padding=[30, 15],
                        font=('Tajawal', 12, 'bold'),
                        background='#e8eaf6',
                        foreground='#5f6368',
                        borderwidth=0)
        style.map('TNotebook.Tab',
                  background=[('selected', '#1a237e')],
                  foreground=[('selected', 'white')],
                  expand=[('selected', [1, 1, 1, 0])])

        # ================== Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ† ==================
        numbers_tab = tk.Frame(main_tab_control, bg="#f0f2f5")
        main_tab_control.add(numbers_tab, text="ğŸ“Š Ù…Ø·Ø§Ø¨Ù‚Ø© Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†")

        # Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        imported_data = []
        comparison_results = []
        missing_in_excel = []

        # Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        import_card = tk.Frame(numbers_tab, bg="white", relief=tk.FLAT, bd=0)
        import_card.pack(fill=tk.X, pady=15, padx=20)

        # Ø¥Ø¶Ø§ÙØ© Ø¸Ù„ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©
        shadow_frame = tk.Frame(import_card, bg="#e0e0e0", height=2)
        shadow_frame.pack(side=tk.BOTTOM, fill=tk.X)

        import_content = tk.Frame(import_card, bg="white", padx=40, pady=30)
        import_content.pack(fill=tk.BOTH)

        # Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø©
        card_header = tk.Frame(import_content, bg="white")
        card_header.pack(fill=tk.X, pady=(0, 20))

        tk.Label(
            card_header,
            text="ğŸ“",
            font=("Arial", 28),
            bg="white",
            fg="#1a237e"
        ).pack(side=tk.RIGHT, padx=10)

        header_text = tk.Frame(card_header, bg="white")
        header_text.pack(side=tk.RIGHT)

        tk.Label(
            header_text,
            text="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©",
            font=("Tajawal", 18, "bold"),
            bg="white",
            fg="#1a237e"
        ).pack(anchor="w")

        tk.Label(
            header_text,
            text="Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†",
            font=("Tajawal", 11),
            bg="white",
            fg="#757575"
        ).pack(anchor="w")

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(import_content, bg="#e0e0e0", height=1)
        separator.pack(fill=tk.X, pady=15)

        # Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (ØªØµÙ…ÙŠÙ… Ù…Ø­Ø³Ù†)
        drop_zone = tk.Frame(import_content, bg="#fafafa", relief=tk.FLAT, bd=1)
        drop_zone.pack(fill=tk.X, pady=10)

        # Ø¥Ø·Ø§Ø± Ù…Ù†Ù‚Ø·
        dashed_border = tk.Frame(drop_zone, bg="white", relief=tk.FLAT)
        dashed_border.pack(fill=tk.BOTH, padx=2, pady=2)

        tk.Label(
            dashed_border,
            text="ğŸ“¤",
            font=("Arial", 32),
            bg="white",
            fg="#9e9e9e"
        ).pack(pady=(20, 10))

        tk.Label(
            dashed_border,
            text="Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø³ØªØ¹Ø±Ø§Ø¶",
            font=("Tajawal", 12),
            bg="white",
            fg="#757575"
        ).pack(pady=(0, 20))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        buttons_frame = tk.Frame(import_content, bg="white")
        buttons_frame.pack(pady=20)

        # ================== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ ==================
        def download_template():
            """ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Excel Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©"""
            try:
                import pandas as pd
                from tkinter import filedialog

                file_path = filedialog.asksaveasfilename(
                    defaultextension=".xlsx",
                    filetypes=[("Excel files", "*.xlsx")],
                    initialfile="Ù‚Ø§Ù„Ø¨_Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚.xlsx"
                )

                if not file_path:
                    return

                # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Ù…Ø¹ Ø¹Ù…ÙˆØ¯ÙŠÙ†
                template_data = {
                    'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': ['101', '102', '103', '104', '105'],
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†': [25, 30, 18, 22, 35]
                }

                df = pd.DataFrame(template_data)

                # Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±
                with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                    df.to_excel(writer, sheet_name='Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚', index=False)
                    worksheet = writer.sheets['Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚']
                    worksheet.sheet_view.rightToLeft = True

                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                    for column in worksheet.columns:
                        max_length = 0
                        column = [cell for cell in column]
                        for cell in column:
                            try:
                                if len(str(cell.value)) > max_length:
                                    max_length = len(str(cell.value))
                            except:
                                pass
                        adjusted_width = (max_length + 2) * 1.5
                        worksheet.column_dimensions[column[0].column_letter].width = adjusted_width

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­:\n{file_path}")

            except ImportError:
                messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© pandas Ùˆ openpyxl\npip install pandas openpyxl")
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ù„Ø¨:\n{str(e)}")

        # ================== Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ==================
        def import_file():
            """Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†"""
            nonlocal imported_data, comparison_results, missing_in_excel

            try:
                import pandas as pd
                from tkinter import filedialog

                file_path = filedialog.askopenfilename(
                    title="Ø§Ø®ØªØ± Ù…Ù„Ù Excel",
                    filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
                )

                if not file_path:
                    return

                # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
                df = pd.read_excel(file_path)

                if df.empty:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº")
                    return

                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ÙŠÙ†
                if len(df.columns) < 2:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ†: Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†")
                    return

                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                df = df.iloc[:, :2]  # Ø£Ø®Ø° Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ÙŠÙ†
                df.columns = ['course_code', 'excel_passed_count']
                df = df.dropna()

                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
                df['course_code'] = df['course_code'].astype(str).str.strip()
                df['excel_passed_count'] = pd.to_numeric(df['excel_passed_count'], errors='coerce').fillna(0).astype(
                    int)

                imported_data = df.to_dict('records')

                if not imported_data:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù")
                    return

                # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                import_info_label.config(
                    text=f"âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ {len(imported_data)} Ø¯ÙˆØ±Ø© Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©",
                    fg="#2e7d32",
                    font=("Tajawal", 12, "bold")
                )

                # ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                validate_btn.config(state=tk.NORMAL, bg="#2e7d32")

                # Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                for widget in numbers_tab.winfo_children():
                    if widget != import_card:
                        widget.destroy()

            except ImportError:
                messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© pandas\npip install pandas openpyxl")
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:\n{str(e)}")

        # ================== Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ==================
        def perform_validation():
            """ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†"""
            nonlocal comparison_results, missing_in_excel

            if not imported_data:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª")
                return

            # Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            for widget in numbers_tab.winfo_children():
                if widget != import_card:
                    widget.destroy()

            comparison_results = []
            missing_in_excel = []

            matched_count = 0  # Ù…ØªØ·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹
            not_matched_count = 0  # ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚
            not_found_in_db = 0  # ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯

            cursor = self.db_conn.cursor()

            # Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            progress_card = tk.Frame(numbers_tab, bg="white", relief=tk.FLAT, bd=0)
            progress_card.pack(fill=tk.X, pady=15, padx=20)

            progress_content = tk.Frame(progress_card, bg="white", padx=40, pady=25)
            progress_content.pack(fill=tk.X)

            tk.Label(
                progress_content,
                text="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©...",
                font=("Tajawal", 14, "bold"),
                bg="white",
                fg="#1a237e"
            ).pack()

            progress_bar = ttk.Progressbar(
                progress_content,
                length=600,
                mode='determinate',
                maximum=len(imported_data)
            )
            progress_bar.pack(pady=15)

            # ØªØ®ØµÙŠØµ Ù„ÙˆÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            style.configure("TProgressbar",
                            troughcolor='#e0e0e0',
                            background='#1a237e',
                            borderwidth=0)

            audit_window.update()

            # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙÙŠ Excel
            excel_course_codes = [item['course_code'] for item in imported_data]

            # ÙØ­Øµ ÙƒÙ„ Ø¯ÙˆØ±Ø© ÙÙŠ Excel
            for i, item in enumerate(imported_data):
                course_code = item['course_code']
                excel_passed_count = item['excel_passed_count']

                # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¯ÙˆØ±Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†
                cursor.execute("""
                    SELECT 
                        c.course_name,
                        c.course_category,
                        DATE(c.start_date) as start_date,
                        DATE(c.end_date) as end_date,
                        COUNT(CASE WHEN p.participant_status IN ('Ù…Ø¬ØªØ§Ø²', 'Ø¨Ø§Ø´Ø±') THEN 1 END) as passed_count
                    FROM courses c
                    LEFT JOIN participants p ON c.id = p.course_id
                    WHERE c.course_code = ?
                    GROUP BY c.id, c.course_name, c.course_category, c.start_date, c.end_date
                """, (course_code,))

                result = cursor.fetchone()

                if result:
                    course_name = result[0]
                    course_category = result[1] if result[1] else ""
                    start_date = result[2] if result[2] else ""
                    end_date = result[3] if result[3] else ""
                    program_passed_count = result[4] if result[4] else 0

                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬ØªØ§Ø²ÙŠÙ†
                    if program_passed_count == excel_passed_count:
                        matched_count += 1
                        status = 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚'
                        color = '#2e7d32'
                    else:
                        not_matched_count += 1
                        difference = program_passed_count - excel_passed_count
                        status = 'âŒ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚'
                        color = '#d32f2f'

                    comparison_results.append({
                        'course_code': course_code,
                        'course_name': course_name,
                        'course_category': course_category,
                        'start_date': start_date,
                        'end_date': end_date,
                        'excel_passed': excel_passed_count,
                        'program_passed': program_passed_count,
                        'difference': program_passed_count - excel_passed_count,
                        'status': status,
                        'color': color
                    })
                else:
                    not_found_in_db += 1
                    comparison_results.append({
                        'course_code': course_code,
                        'course_name': 'â€”',
                        'course_category': 'â€”',
                        'start_date': 'â€”',
                        'end_date': 'â€”',
                        'excel_passed': excel_passed_count,
                        'program_passed': 'â€”',
                        'difference': 'â€”',
                        'status': 'âš ï¸ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬',
                        'color': '#ff9800'
                    })

                # ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                progress_bar['value'] = i + 1
                audit_window.update()

            # ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„ÙŠØ³Øª ÙÙŠ Excel
            cursor.execute("""
                SELECT 
                    c.course_code, 
                    c.course_name,
                    c.course_category,
                    DATE(c.start_date) as start_date,
                    DATE(c.end_date) as end_date,
                    COUNT(CASE WHEN p.participant_status IN ('Ù…Ø¬ØªØ§Ø²', 'Ø¨Ø§Ø´Ø±') THEN 1 END) as passed_count
                FROM courses c
                LEFT JOIN participants p ON c.id = p.course_id
                GROUP BY c.id, c.course_code, c.course_name, c.course_category, c.start_date, c.end_date
                ORDER BY c.course_code
            """)

            all_db_courses = cursor.fetchall()

            for db_course in all_db_courses:
                if db_course[0] not in excel_course_codes:
                    missing_in_excel.append({
                        'course_code': db_course[0],
                        'course_name': db_course[1],
                        'course_category': db_course[2] if db_course[2] else "",
                        'start_date': db_course[3] if db_course[3] else "",
                        'end_date': db_course[4] if db_course[4] else "",
                        'passed_count': db_course[5] if db_course[5] else 0
                    })

            # Ø¥Ø²Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            progress_card.destroy()

            # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            display_results(matched_count, not_matched_count, not_found_in_db)

        # ================== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==================
        def display_results(matched, not_matched, not_found):
            """Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø´Ø¬Ø±Ø©"""
            total = len(comparison_results)
            match_percentage = (matched / total * 100) if total > 0 else 0

            # ================== Ø¨Ø·Ø§Ù‚Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==================
            summary_card = tk.Frame(numbers_tab, bg="white", relief=tk.FLAT, bd=0)
            summary_card.pack(fill=tk.X, pady=15, padx=20)

            summary_content = tk.Frame(summary_card, bg="white", padx=40, pady=30)
            summary_content.pack(fill=tk.BOTH)

            # Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            title_frame = tk.Frame(summary_content, bg="white")
            title_frame.pack(pady=(0, 20))

            tk.Label(
                title_frame,
                text="ğŸ“Š",
                font=("Arial", 24),
                bg="white",
                fg="#1a237e"
            ).pack(side=tk.RIGHT, padx=10)

            tk.Label(
                title_frame,
                text="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø©",
                font=("Tajawal", 20, "bold"),
                bg="white",
                fg="#1a237e"
            ).pack(side=tk.RIGHT)

            # Ø®Ø· ÙØ§ØµÙ„
            tk.Frame(summary_content, bg="#e0e0e0", height=1).pack(fill=tk.X, pady=15)

            # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            stats_container = tk.Frame(summary_content, bg="white")
            stats_container.pack()

            # Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ (Ø¨Ø·Ø§Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©)
            percentage_color = "#2e7d32" if match_percentage >= 90 else "#ff9800" if match_percentage >= 50 else "#d32f2f"

            percentage_card = tk.Frame(stats_container, bg="#f5f5f5", relief=tk.FLAT, bd=0)
            percentage_card.pack(pady=10)

            inner_frame = tk.Frame(percentage_card, bg="#f5f5f5", padx=40, pady=20)
            inner_frame.pack()

            tk.Label(
                inner_frame,
                text="Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©",
                font=("Tajawal", 14),
                bg="#f5f5f5",
                fg="#5f6368"
            ).pack()

            tk.Label(
                inner_frame,
                text=f"{match_percentage:.1f}%",
                font=("Tajawal", 48, "bold"),
                bg="#f5f5f5",
                fg=percentage_color
            ).pack()

            # Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
            cards_frame = tk.Frame(stats_container, bg="white")
            cards_frame.pack(pady=20)

            stats_data = [
                ("âœ… Ù…ØªØ·Ø§Ø¨Ù‚Ø©", matched, "#e8f5e9", "#2e7d32"),
                ("âŒ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©", not_matched, "#ffebee", "#d32f2f"),
                ("âš ï¸ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", not_found, "#fff3e0", "#ff9800"),
                ("ğŸ“ ØºÙŠØ± Ù…Ø¶Ù…Ù†Ø©", len(missing_in_excel), "#f3e5f5", "#9c27b0")
            ]

            for label, value, bg_color, fg_color in stats_data:
                stat_card = tk.Frame(cards_frame, bg=bg_color, relief=tk.FLAT, width=150, height=100)
                stat_card.pack(side=tk.RIGHT, padx=10)
                stat_card.pack_propagate(False)

                tk.Label(
                    stat_card,
                    text=label,
                    font=("Tajawal", 11),
                    bg=bg_color,
                    fg=fg_color
                ).pack(pady=(15, 5))

                tk.Label(
                    stat_card,
                    text=str(value),
                    font=("Tajawal", 24, "bold"),
                    bg=bg_color,
                    fg=fg_color
                ).pack()

            # ================== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ ==================
            tree_card = tk.Frame(numbers_tab, bg="white", relief=tk.FLAT, bd=0)
            tree_card.pack(fill=tk.BOTH, expand=True, pady=15, padx=20)

            tree_content = tk.Frame(tree_card, bg="white", padx=30, pady=25)
            tree_content.pack(fill=tk.BOTH, expand=True)

            # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            tk.Label(
                tree_content,
                text="ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©",
                font=("Tajawal", 18, "bold"),
                bg="white",
                fg="#1a237e"
            ).pack(pady=(0, 15))

            # Ø¥Ù†Ø´Ø§Ø¡ Notebook Ù„Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
            notebook = ttk.Notebook(tree_content)
            notebook.pack(fill=tk.BOTH, expand=True)

            # ================== ØªØ¨ÙˆÙŠØ¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ ==================
            all_results_tab = tk.Frame(notebook, bg="white")
            notebook.add(all_results_tab, text=f"Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ ({len(comparison_results)})")

            # Ø¥Ø·Ø§Ø± Ø§Ù„Ø´Ø¬Ø±Ø©
            all_tree_frame = tk.Frame(all_results_tab, bg="white")
            all_tree_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)

            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø¬Ø±Ø©
            columns = ("Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„ÙØ±Ù‚", "Ù…Ø¬ØªØ§Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", "Ù…Ø¬ØªØ§Ø²ÙŠÙ† Excel",
                       "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", "ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©", "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", "Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©")

            all_tree = ttk.Treeview(all_tree_frame, columns=columns, show="headings", height=15)

            # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            all_tree.column("Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", width=100, anchor="center")
            all_tree.column("Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", width=250, anchor="center")
            all_tree.column("ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©", width=120, anchor="center")
            all_tree.column("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", width=100, anchor="center")
            all_tree.column("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", width=100, anchor="center")
            all_tree.column("Ù…Ø¬ØªØ§Ø²ÙŠÙ† Excel", width=110, anchor="center")
            all_tree.column("Ù…Ø¬ØªØ§Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", width=120, anchor="center")
            all_tree.column("Ø§Ù„ÙØ±Ù‚", width=70, anchor="center")
            all_tree.column("Ø§Ù„Ø­Ø§Ù„Ø©", width=120, anchor="center")

            # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
            for col in columns:
                all_tree.heading(col, text=col)

            # ØªØ®ØµÙŠØµ Ø§Ù„Ø´ÙƒÙ„
            style.configure("Treeview.Heading",
                            font=("Tajawal", 11, "bold"),
                            background="#f5f5f5",
                            foreground="#37474f")
            style.configure("Treeview",
                            font=("Tajawal", 10),
                            rowheight=35,
                            borderwidth=0)

            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            all_tree.tag_configure('matched', background='#e8f5e9', foreground='#2e7d32')
            all_tree.tag_configure('not_matched', background='#ffebee', foreground='#d32f2f')
            all_tree.tag_configure('not_found', background='#fff3e0', foreground='#ff9800')

            for result in comparison_results:
                if result['status'] == 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚':
                    tag = 'matched'
                elif result['status'] == 'âŒ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚':
                    tag = 'not_matched'
                else:
                    tag = 'not_found'

                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙØ±Ù‚
                diff_text = ""
                if result['difference'] != 'â€”':
                    if result['difference'] > 0:
                        diff_text = f"+{result['difference']}"
                    elif result['difference'] < 0:
                        diff_text = str(result['difference'])
                    else:
                        diff_text = "0"
                else:
                    diff_text = "â€”"

                all_tree.insert("", tk.END, values=(
                    result['status'],
                    diff_text,
                    result['program_passed'],
                    result['excel_passed'],
                    result['end_date'],
                    result['start_date'],
                    result['course_category'],
                    result['course_name'],
                    result['course_code']
                ), tags=(tag,))

            # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø´Ø¬Ø±Ø©
            tree_scrollbar_y = ttk.Scrollbar(all_tree_frame, orient="vertical", command=all_tree.yview)
            tree_scrollbar_x = ttk.Scrollbar(all_tree_frame, orient="horizontal", command=all_tree.xview)
            all_tree.configure(
                yscrollcommand=tree_scrollbar_y.set,
                xscrollcommand=tree_scrollbar_x.set
            )

            all_tree.grid(row=0, column=0, sticky="nsew")
            tree_scrollbar_y.grid(row=0, column=1, sticky="ns")
            tree_scrollbar_x.grid(row=1, column=0, sticky="ew")

            all_tree_frame.grid_rowconfigure(0, weight=1)
            all_tree_frame.grid_columnconfigure(0, weight=1)

            # ================== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¶Ù…Ù†Ø© ==================
            if len(missing_in_excel) > 0:
                missing_tab = tk.Frame(notebook, bg="white")
                notebook.add(missing_tab, text=f"ØºÙŠØ± Ù…Ø¶Ù…Ù†Ø© ({len(missing_in_excel)})")

                # ÙˆØµÙ
                desc_frame = tk.Frame(missing_tab, bg="#f3e5f5", relief=tk.FLAT)
                desc_frame.pack(fill=tk.X, padx=15, pady=15)

                tk.Label(
                    desc_frame,
                    text="ğŸ“ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙÙŠ Ù…Ù„Ù Excel Ù„Ù„ÙØ­Øµ",
                    font=("Tajawal", 12, "bold"),
                    bg="#f3e5f5",
                    fg="#9c27b0"
                ).pack(pady=10)

                # Ø¥Ø·Ø§Ø± Ø§Ù„Ø´Ø¬Ø±Ø©
                missing_tree_frame = tk.Frame(missing_tab, bg="white")
                missing_tree_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=(0, 15))

                # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø¬Ø±Ø© Ù„Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¶Ù…Ù†Ø©
                missing_columns = ("Ù…Ø¬ØªØ§Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©",
                                   "ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©", "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", "Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©")

                missing_tree = ttk.Treeview(missing_tree_frame, columns=missing_columns, show="headings", height=15)

                missing_tree.column("Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", width=120, anchor="center")
                missing_tree.column("Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", width=300, anchor="center")
                missing_tree.column("ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©", width=150, anchor="center")
                missing_tree.column("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", width=120, anchor="center")
                missing_tree.column("ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", width=120, anchor="center")
                missing_tree.column("Ù…Ø¬ØªØ§Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", width=130, anchor="center")

                for col in missing_columns:
                    missing_tree.heading(col, text=col)

                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                missing_tree.tag_configure('missing', background='#f3e5f5', foreground='#9c27b0')

                for course in missing_in_excel:
                    missing_tree.insert("", tk.END, values=(
                        course['passed_count'],
                        course['end_date'],
                        course['start_date'],
                        course['course_category'],
                        course['course_name'],
                        course['course_code']
                    ), tags=('missing',))

                # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ±
                missing_scrollbar_y = ttk.Scrollbar(missing_tree_frame, orient="vertical", command=missing_tree.yview)
                missing_scrollbar_x = ttk.Scrollbar(missing_tree_frame, orient="horizontal", command=missing_tree.xview)
                missing_tree.configure(
                    yscrollcommand=missing_scrollbar_y.set,
                    xscrollcommand=missing_scrollbar_x.set
                )

                missing_tree.grid(row=0, column=0, sticky="nsew")
                missing_scrollbar_y.grid(row=0, column=1, sticky="ns")
                missing_scrollbar_x.grid(row=1, column=0, sticky="ew")

                missing_tree_frame.grid_rowconfigure(0, weight=1)
                missing_tree_frame.grid_columnconfigure(0, weight=1)

            # ================== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© ==================
            if not_matched > 0 or not_found > 0:
                issues_tab = tk.Frame(notebook, bg="white")
                notebook.add(issues_tab, text=f"ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© ({not_matched + not_found})")

                # Ø¥Ø·Ø§Ø± Ø§Ù„Ø´Ø¬Ø±Ø©
                issues_tree_frame = tk.Frame(issues_tab, bg="white")
                issues_tree_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)

                issues_tree = ttk.Treeview(issues_tree_frame, columns=columns, show="headings", height=15)

                # Ù†ÙØ³ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                for i, col in enumerate(columns):
                    issues_tree.column(col, width=all_tree.column(col)['width'], anchor="center")
                    issues_tree.heading(col, text=col)

                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø© ÙÙ‚Ø·
                issues_tree.tag_configure('not_matched', background='#ffebee', foreground='#d32f2f')
                issues_tree.tag_configure('not_found', background='#fff3e0', foreground='#ff9800')

                for result in comparison_results:
                    if result['status'] != 'âœ… Ù…ØªØ·Ø§Ø¨Ù‚':
                        tag = 'not_matched' if result['status'] == 'âŒ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚' else 'not_found'

                        diff_text = ""
                        if result['difference'] != 'â€”':
                            if result['difference'] > 0:
                                diff_text = f"+{result['difference']}"
                            elif result['difference'] < 0:
                                diff_text = str(result['difference'])
                            else:
                                diff_text = "0"
                        else:
                            diff_text = "â€”"

                        issues_tree.insert("", tk.END, values=(
                            result['status'],
                            diff_text,
                            result['program_passed'],
                            result['excel_passed'],
                            result['end_date'],
                            result['start_date'],
                            result['course_category'],
                            result['course_name'],
                            result['course_code']
                        ), tags=(tag,))

                # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ±
                issues_scrollbar_y = ttk.Scrollbar(issues_tree_frame, orient="vertical", command=issues_tree.yview)
                issues_scrollbar_x = ttk.Scrollbar(issues_tree_frame, orient="horizontal", command=issues_tree.xview)
                issues_tree.configure(
                    yscrollcommand=issues_scrollbar_y.set,
                    xscrollcommand=issues_scrollbar_x.set
                )

                issues_tree.grid(row=0, column=0, sticky="nsew")
                issues_scrollbar_y.grid(row=0, column=1, sticky="ns")
                issues_scrollbar_x.grid(row=1, column=0, sticky="ew")

                issues_tree_frame.grid_rowconfigure(0, weight=1)
                issues_tree_frame.grid_columnconfigure(0, weight=1)

            # ================== Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ==================
            export_frame = tk.Frame(numbers_tab, bg="#f0f2f5")
            export_frame.pack(pady=20)

            def export_results():
                """ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Excel"""
                try:
                    import pandas as pd
                    from tkinter import filedialog
                    import datetime

                    file_path = filedialog.asksaveasfilename(
                        defaultextension=".xlsx",
                        filetypes=[("Excel files", "*.xlsx")],
                        initialfile=f"Ù†ØªØ§Ø¦Ø¬_Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
                    )

                    if not file_path:
                        return

                    with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                        # ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù„Ø®Øµ
                        summary_data = {
                            'Ø§Ù„ÙˆØµÙ': [
                                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙØ­ÙˆØµØ©',
                                'Ø¯ÙˆØ±Ø§Øª Ù…ØªØ·Ø§Ø¨Ù‚Ø©',
                                'Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©',
                                'Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬',
                                'Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ø§Ù„Ù…Ø¶Ù…Ù†Ø© ÙÙŠ Ø§Ù„ÙØ­Øµ',
                                'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ·Ø§Ø¨Ù‚'
                            ],
                            'Ø§Ù„Ù‚ÙŠÙ…Ø©': [
                                total,
                                matched,
                                not_matched,
                                not_found,
                                len(missing_in_excel),
                                f"{match_percentage:.1f}%"
                            ]
                        }
                        summary_df = pd.DataFrame(summary_data)
                        summary_df.to_excel(writer, sheet_name='Ø§Ù„Ù…Ù„Ø®Øµ', index=False)
                        worksheet = writer.sheets['Ø§Ù„Ù…Ù„Ø®Øµ']
                        worksheet.sheet_view.rightToLeft = True

                        # ÙˆØ±Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
                        detailed_results = []
                        for result in comparison_results:
                            detailed_results.append({
                                'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': result['course_code'],
                                'Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': result['course_name'],
                                'ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©': result['course_category'],
                                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': result['start_date'],
                                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': result['end_date'],
                                'Ù…Ø¬ØªØ§Ø²ÙŠÙ† Excel': result['excel_passed'],
                                'Ù…Ø¬ØªØ§Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬': result['program_passed'],
                                'Ø§Ù„ÙØ±Ù‚': result['difference'] if result['difference'] != 'â€”' else '',
                                'Ø§Ù„Ø­Ø§Ù„Ø©': result['status'].replace('âœ… ', '').replace('âŒ ', '').replace('âš ï¸ ', '')
                            })

                        if detailed_results:
                            results_df = pd.DataFrame(detailed_results)
                            results_df.to_excel(writer, sheet_name='Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©', index=False)
                            worksheet = writer.sheets['Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©']
                            worksheet.sheet_view.rightToLeft = True

                        # ÙˆØ±Ù‚Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¶Ù…Ù†Ø©
                        if missing_in_excel:
                            missing_data = []
                            for course in missing_in_excel:
                                missing_data.append({
                                    'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': course['course_code'],
                                    'Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': course['course_name'],
                                    'ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©': course['course_category'],
                                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©': course['start_date'],
                                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©': course['end_date'],
                                    'Ù…Ø¬ØªØ§Ø²ÙŠÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬': course['passed_count']
                                })

                            missing_df = pd.DataFrame(missing_data)
                            missing_df.to_excel(writer, sheet_name='ØºÙŠØ± Ù…Ø¶Ù…Ù†Ø© ÙÙŠ Ø§Ù„ÙØ­Øµ', index=False)
                            worksheet = writer.sheets['ØºÙŠØ± Ù…Ø¶Ù…Ù†Ø© ÙÙŠ Ø§Ù„ÙØ­Øµ']
                            worksheet.sheet_view.rightToLeft = True

                    messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­:\n{file_path}")

                except Exception as e:
                    messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬:\n{str(e)}")

            tk.Button(
                export_frame,
                text="ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¥Ù„Ù‰ Excel",
                font=("Tajawal", 14, "bold"),
                bg="#1a237e",
                fg="white",
                padx=40,
                pady=15,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=export_results
            ).pack()

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        import_btn = tk.Button(
            buttons_frame,
            text="ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel",
            font=("Tajawal", 12, "bold"),
            bg="#1a237e",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=import_file
        )
        import_btn.pack(side=tk.RIGHT, padx=8)

        # Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨
        template_btn = tk.Button(
            buttons_frame,
            text="ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº",
            font=("Tajawal", 12, "bold"),
            bg="#607d8b",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=download_template
        )
        template_btn.pack(side=tk.RIGHT, padx=8)

        # Ø²Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        validate_btn = tk.Button(
            buttons_frame,
            text="âœ“ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚",
            font=("Tajawal", 12, "bold"),
            bg="#9e9e9e",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=perform_validation,
            state=tk.DISABLED
        )
        validate_btn.pack(side=tk.RIGHT, padx=8)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        import_info_label = tk.Label(
            import_content,
            text="Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…Ù„Ù Ø¨Ø¹Ø¯",
            font=("Tajawal", 11),
            bg="white",
            fg="#9e9e9e"
        )
        import_info_label.pack(pady=(20, 0))

        # ================== Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª ==================
        verification_tab = tk.Frame(main_tab_control, bg="#f0f2f5")
        main_tab_control.add(verification_tab, text="ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª")

        # Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        import_verify_card = tk.Frame(verification_tab, bg="white", relief=tk.FLAT, bd=0)
        import_verify_card.pack(fill=tk.X, pady=15, padx=20)

        import_verify_content = tk.Frame(import_verify_card, bg="white", padx=40, pady=30)
        import_verify_content.pack(fill=tk.BOTH)

        # Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        verify_header = tk.Frame(import_verify_content, bg="white")
        verify_header.pack(fill=tk.X, pady=(0, 20))

        tk.Label(
            verify_header,
            text="ğŸ”",
            font=("Arial", 28),
            bg="white",
            fg="#1a237e"
        ).pack(side=tk.RIGHT, padx=10)

        verify_header_text = tk.Frame(verify_header, bg="white")
        verify_header_text.pack(side=tk.RIGHT)

        tk.Label(
            verify_header_text,
            text="Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª",
            font=("Tajawal", 18, "bold"),
            bg="white",
            fg="#1a237e"
        ).pack(anchor="w")

        tk.Label(
            verify_header_text,
            text="Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡Ø§",
            font=("Tajawal", 11),
            bg="white",
            fg="#757575"
        ).pack(anchor="w")

        # Ø®Ø· ÙØ§ØµÙ„
        tk.Frame(import_verify_content, bg="#e0e0e0", height=1).pack(fill=tk.X, pady=15)

        # Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚
        verify_buttons_frame = tk.Frame(import_verify_content, bg="white")
        verify_buttons_frame.pack(pady=20)

        # ================== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ ==================
        def download_verify_template():
            """ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Excel Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Øª"""
            try:
                import pandas as pd
                from tkinter import filedialog

                file_path = filedialog.asksaveasfilename(
                    defaultextension=".xlsx",
                    filetypes=[("Excel files", "*.xlsx")],
                    initialfile="Ù‚Ø§Ù„Ø¨_Ø§Ù„ØªØ­Ù‚Ù‚_Ù…Ù†_Ø§Ù„Ø¯ÙˆØ±Ø§Øª.xlsx"
                )

                if not file_path:
                    return

                # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù„Ø¨ Ù…Ø¹ Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯
                template_data = {
                    'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': ['101', '102', '103', '104', '105', '106', '107', '108', '109', '110']
                }

                df = pd.DataFrame(template_data)

                # Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
                with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                    df.to_excel(writer, sheet_name='Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª', index=False)
                    worksheet = writer.sheets['Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª']
                    worksheet.sheet_view.rightToLeft = True

                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                    from openpyxl.styles import Font, Alignment, PatternFill

                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
                    header_cell = worksheet['A1']
                    header_cell.font = Font(name='Tajawal', size=12, bold=True, color='FFFFFF')
                    header_cell.fill = PatternFill(start_color='1e3a5f', end_color='1e3a5f', fill_type='solid')
                    header_cell.alignment = Alignment(horizontal='center', vertical='center')

                    # Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙˆØ¯
                    worksheet.column_dimensions['A'].width = 20

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­:\n{file_path}")

            except ImportError:
                messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© pandas Ùˆ openpyxl\npip install pandas openpyxl")
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ù„Ø¨:\n{str(e)}")

        # ================== Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Øª ==================
        def import_and_verify_courses():
            """Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª"""
            try:
                import pandas as pd
                from tkinter import filedialog
                from tkinter import scrolledtext

                file_path = filedialog.askopenfilename(
                    title="Ø§Ø®ØªØ± Ù…Ù„Ù Excel Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª",
                    filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
                )

                if not file_path:
                    return

                # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
                df = pd.read_excel(file_path)

                if df.empty:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº")
                    return

                # Ø£Ø®Ø° Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ ÙÙ‚Ø·
                course_codes = df.iloc[:, 0].astype(str).str.strip().tolist()
                course_codes = [code for code in course_codes if code and code != 'nan']

                if not course_codes:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù… Ø¯ÙˆØ±Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù")
                    return

                # Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                for widget in verification_tab.winfo_children():
                    if widget != import_verify_card:
                        widget.destroy()

                # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                cursor = self.db_conn.cursor()

                # Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                cursor.execute("SELECT course_code FROM courses")
                db_courses = set([row[0] for row in cursor.fetchall()])

                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                imported_set = set(course_codes)
                found_courses = imported_set.intersection(db_courses)
                not_found_courses = imported_set - db_courses

                # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                results_card = tk.Frame(verification_tab, bg="white", relief=tk.FLAT, bd=0)
                results_card.pack(fill=tk.BOTH, expand=True, pady=15, padx=20)

                results_content = tk.Frame(results_card, bg="white", padx=40, pady=30)
                results_content.pack(fill=tk.BOTH, expand=True)

                # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                title_frame = tk.Frame(results_content, bg="white")
                title_frame.pack(pady=(0, 20))

                tk.Label(
                    title_frame,
                    text="ğŸ“Š",
                    font=("Arial", 24),
                    bg="white",
                    fg="#1a237e"
                ).pack(side=tk.RIGHT, padx=10)

                tk.Label(
                    title_frame,
                    text="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª",
                    font=("Tajawal", 20, "bold"),
                    bg="white",
                    fg="#1a237e"
                ).pack(side=tk.RIGHT)

                # Ø®Ø· ÙØ§ØµÙ„
                tk.Frame(results_content, bg="#e0e0e0", height=1).pack(fill=tk.X, pady=15)

                # Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                stats_frame = tk.Frame(results_content, bg="white")
                stats_frame.pack(pady=20)

                total_imported = len(imported_set)
                total_found = len(found_courses)
                total_not_found = len(not_found_courses)
                match_percentage = (total_found / total_imported * 100) if total_imported > 0 else 0

                # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                stats_row = tk.Frame(stats_frame, bg="white")
                stats_row.pack()

                # Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
                stat_cards = [
                    ("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©", total_imported, "#e3f2fd", "#1976d2"),
                    ("âœ… Ù…ÙˆØ¬ÙˆØ¯Ø©", total_found, "#e8f5e9", "#2e7d32"),
                    ("âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", total_not_found, "#ffebee", "#d32f2f"),
                    ("Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©", f"{match_percentage:.1f}%", "#f5f5f5",
                     "#2e7d32" if match_percentage >= 90 else "#ff9800" if match_percentage >= 50 else "#d32f2f")
                ]

                for label, value, bg_color, fg_color in stat_cards:
                    stat = tk.Frame(stats_row, bg=bg_color, relief=tk.FLAT, width=160, height=100)
                    stat.pack(side=tk.RIGHT, padx=10, pady=10)
                    stat.pack_propagate(False)

                    tk.Label(
                        stat,
                        text=label,
                        font=("Tajawal", 11),
                        bg=bg_color,
                        fg=fg_color
                    ).pack(pady=(15, 5))

                    tk.Label(
                        stat,
                        text=str(value),
                        font=("Tajawal", 22, "bold"),
                        bg=bg_color,
                        fg=fg_color
                    ).pack()

                # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                if total_not_found == 0:
                    # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                    success_frame = tk.Frame(results_content, bg="#e8f5e9", relief=tk.FLAT)
                    success_frame.pack(fill=tk.X, pady=20)

                    inner = tk.Frame(success_frame, bg="#e8f5e9", padx=30, pady=20)
                    inner.pack()

                    tk.Label(
                        inner,
                        text="âœ… Ù…Ù…ØªØ§Ø²! Ø¬Ù…ÙŠØ¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…ØªØ·Ø§Ø¨Ù‚Ø©",
                        font=("Tajawal", 16, "bold"),
                        bg="#e8f5e9",
                        fg="#2e7d32"
                    ).pack()

                    tk.Label(
                        inner,
                        text=f"ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† {total_imported} Ø¯ÙˆØ±Ø© ÙˆØ¬Ù…ÙŠØ¹Ù‡Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
                        font=("Tajawal", 12),
                        bg="#e8f5e9",
                        fg="#2e7d32"
                    ).pack(pady=(5, 0))

                else:
                    # ÙŠÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
                    warning_frame = tk.Frame(results_content, bg="#fff3e0", relief=tk.FLAT)
                    warning_frame.pack(fill=tk.X, pady=15)

                    tk.Label(
                        warning_frame,
                        text="âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
                        font=("Tajawal", 14, "bold"),
                        bg="#fff3e0",
                        fg="#ff9800"
                    ).pack(pady=10)

                    # Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                    not_found_frame = tk.Frame(results_content, bg="white")
                    not_found_frame.pack(fill=tk.BOTH, expand=True, pady=15)

                    tk.Label(
                        not_found_frame,
                        text="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:",
                        font=("Tajawal", 13, "bold"),
                        bg="white",
                        fg="#d32f2f"
                    ).pack(anchor="e", pady=(0, 10))

                    # Ø¥Ø·Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª
                    courses_display_frame = tk.Frame(not_found_frame, bg="white", relief=tk.SUNKEN, bd=1)
                    courses_display_frame.pack(fill=tk.BOTH, expand=True, padx=15)

                    # Text widget Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
                    courses_text = scrolledtext.ScrolledText(
                        courses_display_frame,
                        wrap=tk.WORD,
                        width=60,
                        height=10,
                        font=("Consolas", 11),
                        bg="#fff5f5",
                        fg="#d32f2f"
                    )
                    courses_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

                    # Ø¥Ø¶Ø§ÙØ© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                    not_found_sorted = sorted(list(not_found_courses))
                    courses_text.insert(tk.END, ", ".join(not_found_sorted))
                    courses_text.config(state=tk.DISABLED)

                    # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    action_buttons_frame = tk.Frame(not_found_frame, bg="white")
                    action_buttons_frame.pack(pady=15)

                    def copy_not_found_courses():
                        """Ù†Ø³Ø® Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©"""
                        try:
                            audit_window.clipboard_clear()
                            audit_window.clipboard_append(", ".join(not_found_sorted))

                            copy_msg = tk.Label(
                                action_buttons_frame,
                                text="âœ“ ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­",
                                font=("Tajawal", 10),
                                bg="white",
                                fg="#2e7d32"
                            )
                            copy_msg.pack()
                            audit_window.after(2000, copy_msg.destroy)
                        except Exception as e:
                            messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:\n{str(e)}")

                    # Ø²Ø± Ø§Ù„Ù†Ø³Ø®
                    copy_btn = tk.Button(
                        action_buttons_frame,
                        text="ğŸ“‹ Ù†Ø³Ø® Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª",
                        font=("Tajawal", 11, "bold"),
                        bg="#ff9800",
                        fg="white",
                        padx=25,
                        pady=10,
                        bd=0,
                        relief=tk.FLAT,
                        cursor="hand2",
                        command=copy_not_found_courses
                    )
                    copy_btn.pack(side=tk.RIGHT, padx=8)

                    def export_not_found():
                        """ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¥Ù„Ù‰ Excel"""
                        try:
                            import pandas as pd
                            from tkinter import filedialog
                            import datetime

                            file_path = filedialog.asksaveasfilename(
                                defaultextension=".xlsx",
                                filetypes=[("Excel files", "*.xlsx")],
                                initialfile=f"Ø¯ÙˆØ±Ø§Øª_ØºÙŠØ±_Ù…ÙˆØ¬ÙˆØ¯Ø©_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
                            )

                            if not file_path:
                                return

                            # Ø¥Ù†Ø´Ø§Ø¡ DataFrame
                            df = pd.DataFrame({
                                'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': not_found_sorted,
                                'Ø§Ù„Ø­Ø§Ù„Ø©': ['ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬'] * len(not_found_sorted)
                            })

                            # Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
                            with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                                df.to_excel(writer, sheet_name='Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©', index=False)
                                worksheet = writer.sheets['Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©']
                                worksheet.sheet_view.rightToLeft = True

                                from openpyxl.styles import Font, Alignment, PatternFill, Border, Side

                                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
                                header_font = Font(name='Tajawal', size=12, bold=True, color='FFFFFF')
                                header_fill = PatternFill(start_color='d32f2f', end_color='d32f2f', fill_type='solid')

                                for cell in worksheet[1]:
                                    cell.font = header_font
                                    cell.fill = header_fill
                                    cell.alignment = Alignment(horizontal='center', vertical='center')

                                # Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                                worksheet.column_dimensions['A'].width = 20
                                worksheet.column_dimensions['B'].width = 30

                            messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:\n{file_path}")

                        except Exception as e:
                            messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:\n{str(e)}")

                    # Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
                    export_btn = tk.Button(
                        action_buttons_frame,
                        text="ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel",
                        font=("Tajawal", 11, "bold"),
                        bg="#607d8b",
                        fg="white",
                        padx=25,
                        pady=10,
                        bd=0,
                        relief=tk.FLAT,
                        cursor="hand2",
                        command=export_not_found
                    )
                    export_btn.pack(side=tk.RIGHT, padx=8)

                # Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„
                export_full_frame = tk.Frame(results_content, bg="white")
                export_full_frame.pack(pady=20)

                def export_full_report():
                    """ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„ Ø¨Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚"""
                    try:
                        import pandas as pd
                        from tkinter import filedialog
                        import datetime

                        file_path = filedialog.asksaveasfilename(
                            defaultextension=".xlsx",
                            filetypes=[("Excel files", "*.xlsx")],
                            initialfile=f"ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØªØ­Ù‚Ù‚_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
                        )

                        if not file_path:
                            return

                        with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                            # ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù„Ø®Øµ
                            summary_df = pd.DataFrame({
                                'Ø§Ù„ÙˆØµÙ': [
                                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø©',
                                    'Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©',
                                    'Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©',
                                    'Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©'
                                ],
                                'Ø§Ù„Ù‚ÙŠÙ…Ø©': [
                                    total_imported,
                                    total_found,
                                    total_not_found,
                                    f"{match_percentage:.1f}%"
                                ]
                            })
                            summary_df.to_excel(writer, sheet_name='Ø§Ù„Ù…Ù„Ø®Øµ', index=False)

                            # ÙˆØ±Ù‚Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø©
                            all_courses = []
                            for code in course_codes:
                                status = "Ù…ÙˆØ¬ÙˆØ¯ âœ…" if code in found_courses else "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ âŒ"
                                all_courses.append({'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': code, 'Ø§Ù„Ø­Ø§Ù„Ø©': status})

                            all_df = pd.DataFrame(all_courses)
                            all_df.to_excel(writer, sheet_name='Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª', index=False)

                            # ÙˆØ±Ù‚Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                            if not_found_courses:
                                not_found_df = pd.DataFrame({'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': sorted(list(not_found_courses))})
                                not_found_df.to_excel(writer, sheet_name='Ø§Ù„Ø¯ÙˆØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©', index=False)

                            # ÙˆØ±Ù‚Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                            if found_courses:
                                found_df = pd.DataFrame({'Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ±Ø©': sorted(list(found_courses))})
                                found_df.to_excel(writer, sheet_name='Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©', index=False)

                            # Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
                            workbook = writer.book
                            for sheet_name in workbook.sheetnames:
                                worksheet = workbook[sheet_name]
                                worksheet.sheet_view.rightToLeft = True

                                from openpyxl.styles import Font, Alignment, PatternFill

                                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
                                header_font = Font(name='Tajawal', size=12, bold=True, color='FFFFFF')
                                header_fill = PatternFill(start_color='1e3a5f', end_color='1e3a5f', fill_type='solid')

                                for cell in worksheet[1]:
                                    cell.font = header_font
                                    cell.fill = header_fill
                                    cell.alignment = Alignment(horizontal='center', vertical='center')

                                # Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                                for column in worksheet.columns:
                                    max_length = 0
                                    column_letter = column[0].column_letter
                                    for cell in column:
                                        try:
                                            if len(str(cell.value)) > max_length:
                                                max_length = len(str(cell.value))
                                        except:
                                            pass
                                    adjusted_width = min(max_length + 5, 50)
                                    worksheet.column_dimensions[column_letter].width = adjusted_width

                        messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„:\n{file_path}")

                    except Exception as e:
                        messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:\n{str(e)}")

                tk.Button(
                    export_full_frame,
                    text="ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„",
                    font=("Tajawal", 13, "bold"),
                    bg="#1a237e",
                    fg="white",
                    padx=35,
                    pady=12,
                    bd=0,
                    relief=tk.FLAT,
                    cursor="hand2",
                    command=export_full_report
                ).pack()

            except ImportError:
                messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© pandas\npip install pandas openpyxl")
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚:\n{str(e)}")

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        verify_import_btn = tk.Button(
            verify_buttons_frame,
            text="ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙˆØ±Ø§Øª",
            font=("Tajawal", 12, "bold"),
            bg="#1a237e",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=import_and_verify_courses
        )
        verify_import_btn.pack(side=tk.RIGHT, padx=8)

        # Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚
        verify_template_btn = tk.Button(
            verify_buttons_frame,
            text="ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚",
            font=("Tajawal", 12, "bold"),
            bg="#607d8b",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=download_verify_template
        )
        verify_template_btn.pack(side=tk.RIGHT, padx=8)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        verify_info_label = tk.Label(
            import_verify_content,
            text="Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…Ù„Ù Ø¨Ø¹Ø¯",
            font=("Tajawal", 11),
            bg="white",
            fg="#9e9e9e"
        )
        verify_info_label.pack(pady=(20, 0))

        # ================== Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù„Ø«: Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ==================
        identity_tab = tk.Frame(main_tab_control, bg="#f0f2f5")
        main_tab_control.add(identity_tab, text="ğŸ” Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©")

        # Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        imported_identity_data = []
        comparison_identity_results = []
        not_in_excel = []
        not_in_program = []

        # Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        import_identity_card = tk.Frame(identity_tab, bg="white", relief=tk.FLAT, bd=0)
        import_identity_card.pack(fill=tk.X, pady=15, padx=20)

        import_identity_content = tk.Frame(import_identity_card, bg="white", padx=40, pady=30)
        import_identity_content.pack(fill=tk.BOTH)

        # Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        identity_header = tk.Frame(import_identity_content, bg="white")
        identity_header.pack(fill=tk.X, pady=(0, 20))

        tk.Label(
            identity_header,
            text="ğŸ”",
            font=("Arial", 28),
            bg="white",
            fg="#1a237e"
        ).pack(side=tk.RIGHT, padx=10)

        identity_header_text = tk.Frame(identity_header, bg="white")
        identity_header_text.pack(side=tk.RIGHT)

        tk.Label(
            identity_header_text,
            text="Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©",
            font=("Tajawal", 18, "bold"),
            bg="white",
            fg="#1a237e"
        ).pack(anchor="w")

        tk.Label(
            identity_header_text,
            text="Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø³Ø¨Ø¨",
            font=("Tajawal", 11),
            bg="white",
            fg="#757575"
        ).pack(anchor="w")

        # Ø®Ø· ÙØ§ØµÙ„
        tk.Frame(import_identity_content, bg="#e0e0e0", height=1).pack(fill=tk.X, pady=15)

        buttons_identity_frame = tk.Frame(import_identity_content, bg="white")
        buttons_identity_frame.pack(pady=20)

        # ================== Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ ==================
        def download_identity_template():
            try:
                import pandas as pd
                from tkinter import filedialog

                file_path = filedialog.asksaveasfilename(
                    defaultextension=".xlsx",
                    filetypes=[("Excel files", "*.xlsx")],
                    initialfile="Ù‚Ø§Ù„Ø¨_Ù…ØµØ§Ø¯Ù‚Ø©_Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†.xlsx"
                )

                if not file_path:
                    return

                template_data = {
                    'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©': ['1234567890', '0987654321', '1111111111'],
                    'Ø§Ù„Ø§Ø³Ù…': ['Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', 'Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ', 'Ø®Ø§Ù„Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡'],
                    'Ø§Ù„Ø­Ø§Ù„Ø©': ['Ø¨Ø§Ø´Ø±', 'Ø±ÙØ¶', 'Ø±ÙØ¶'],
                    'Ø§Ù„Ø³Ø¨Ø¨': ['', 'Ø¹Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø©', 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙˆØ±Ø©']
                }

                df = pd.DataFrame(template_data)

                with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                    df.to_excel(writer, sheet_name='Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†', index=False)
                    worksheet = writer.sheets['Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†']
                    worksheet.sheet_view.rightToLeft = True

                    # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                    worksheet.column_dimensions['A'].width = 20
                    worksheet.column_dimensions['B'].width = 30
                    worksheet.column_dimensions['C'].width = 15
                    worksheet.column_dimensions['D'].width = 40

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨:\n{file_path}")

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø§Ù„Ø¨:\n{str(e)}")

        # ================== Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆÙ…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==================
        def import_identity_file():
            nonlocal imported_identity_data, comparison_identity_results, not_in_excel, not_in_program

            try:
                import pandas as pd
                from tkinter import filedialog

                file_path = filedialog.askopenfilename(
                    title="Ø§Ø®ØªØ± Ù…Ù„Ù Excel",
                    filetypes=[("Excel files", "*.xlsx *.xls"), ("All files", "*.*")]
                )

                if not file_path:
                    return

                # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
                df = pd.read_excel(file_path)

                if df.empty:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº")
                    return

                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                if len(df.columns) < 4:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡",
                                           f"Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ {len(df.columns)} Ø£Ø¹Ù…Ø¯Ø© ÙÙ‚Ø·. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 4 Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„")
                    return

                # Ø£Ø®Ø° Ø£ÙˆÙ„ 4 Ø£Ø¹Ù…Ø¯Ø© ÙÙ‚Ø· ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØªÙ‡Ø§
                df = df.iloc[:, :4].copy()  # Ø£Ø®Ø° Ø£ÙˆÙ„ 4 Ø£Ø¹Ù…Ø¯Ø© ÙÙ‚Ø·
                df.columns = ['national_id', 'name', 'status', 'reason']

                # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ© (Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©)
                df = df.dropna(subset=['national_id'])

                # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                df['national_id'] = df['national_id'].astype(str).str.strip()
                # Ø¥Ø²Ø§Ù„Ø© .0 Ù…Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
                df['national_id'] = df['national_id'].apply(lambda x: x.split('.')[0] if '.' in x else x)

                df['name'] = df['name'].fillna('').astype(str).str.strip()
                df['status'] = df['status'].fillna('').astype(str).str.strip()
                df['reason'] = df['reason'].fillna('').astype(str).str.strip()

                # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ø¨Ù‡Ø§ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©
                df = df[(df['national_id'] != '') & (df['national_id'] != 'nan')]

                imported_identity_data = df.to_dict('records')

                if not imported_identity_data:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù")
                    return

                # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                import_identity_info.config(
                    text=f"âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ {len(imported_identity_data)} Ù…ØªØ¯Ø±Ø¨ Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©",
                    fg="#2e7d32",
                    font=("Tajawal", 12, "bold")
                )

                # ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
                validate_identity_btn.config(state=tk.NORMAL, bg="#2e7d32")

                # Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                for widget in identity_tab.winfo_children():
                    if widget != import_identity_card:
                        widget.destroy()

                # Ø¹Ø±Ø¶ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù„Ù„ØªØ£ÙƒØ¯
                print(f"ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ {len(imported_identity_data)} Ø³Ø¬Ù„")
                if imported_identity_data:
                    print("Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:")
                    for i, item in enumerate(imported_identity_data[:3]):
                        print(
                            f"  {i + 1}. Ø§Ù„Ù‡ÙˆÙŠØ©: {item['national_id']}, Ø§Ù„Ø§Ø³Ù…: {item['name']}, Ø§Ù„Ø­Ø§Ù„Ø©: {item['status']}")

            except ImportError:
                messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ù…ÙƒØªØ¨Ø© pandas\npip install pandas openpyxl")
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:\n{str(e)}")

        # ================== Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ==================
        def perform_identity_validation():
            nonlocal comparison_identity_results, not_in_excel, not_in_program

            if not imported_identity_data:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª")
                return

            # Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            for widget in identity_tab.winfo_children():
                if widget != import_identity_card:
                    widget.destroy()

            comparison_identity_results = []
            not_in_program = []
            not_in_excel = []
            conflicts_list = []
            matched_list = []

            cursor = self.db_conn.cursor()

            # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            progress_card = tk.Frame(identity_tab, bg="white", relief=tk.FLAT, bd=0)
            progress_card.pack(fill=tk.X, pady=15, padx=20)

            progress_content = tk.Frame(progress_card, bg="white", padx=40, pady=25)
            progress_content.pack(fill=tk.X)

            tk.Label(
                progress_content,
                text="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...",
                font=("Tajawal", 14, "bold"),
                bg="white",
                fg="#1a237e"
            ).pack()

            progress_bar = ttk.Progressbar(
                progress_content,
                length=600,
                mode='determinate',
                maximum=len(imported_identity_data)
            )
            progress_bar.pack(pady=15)

            audit_window.update()

            # Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ† Ù…Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
            cursor.execute("""
                SELECT DISTINCT
                    p.national_id,
                    p.participant_name,
                    p.participant_status,
                    p.cancellation_reason,
                    c.course_name,
                    c.course_code
                FROM participants p
                JOIN courses c ON p.course_id = c.id
                WHERE p.participant_status NOT IN ('Ù…Ø¬ØªØ§Ø²', 'Ø¨Ø§Ø´Ø±')
                AND p.participant_status IS NOT NULL
            """)

            program_rejected = {}
            for row in cursor.fetchall():
                if row[0]:  # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù…ÙˆØ¬ÙˆØ¯
                    national_id = str(row[0]).strip()
                    if '.' in national_id:
                        national_id = national_id.split('.')[0]
                    program_rejected[national_id] = {
                        'name': row[1],
                        'status': row[2],
                        'reason': row[3],
                        'course_name': row[4],
                        'course_code': row[5]
                    }

            # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ù…ÙˆØ³ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù…Ù† Excel
            excel_rejected = {}
            for trainee in imported_identity_data:
                national_id = str(trainee['national_id']).strip()
                if '.' in national_id:
                    national_id = national_id.split('.')[0]

                excel_rejected[national_id] = {
                    'name': trainee['name'],
                    'status': trainee['status'],
                    'reason': trainee['reason']
                }

            # Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
            for i, (national_id, excel_data) in enumerate(excel_rejected.items()):
                if national_id in program_rejected:
                    # Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠÙ† (Ù…Ø±ÙÙˆØ¶)
                    program_data = program_rejected[national_id]

                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø­Ø§Ù„Ø©
                    excel_status_lower = excel_data['status'].lower().strip()
                    program_status_lower = program_data['status'].lower() if program_data['status'] else ''

                    is_match = False
                    status_icon = ""
                    color = ""

                    # ÙƒÙ„Ø§Ù‡Ù…Ø§ Ø±ÙØ¶ Ø¨Ø£ÙŠ Ø´ÙƒÙ„
                    if ('Ø±ÙØ¶' in excel_status_lower or 'Ù…Ø±ÙÙˆØ¶' in excel_status_lower or
                            'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' in excel_status_lower or 'Ø¥Ù„ØºØ§Ø¡' in excel_status_lower):
                        is_match = True
                        status_icon = "âœ… Ù…ØªØ·Ø§Ø¨Ù‚"
                        color = "#2e7d32"
                        matched_list.append({
                            'national_id': national_id,
                            'name': excel_data['name'],
                            'excel_status': excel_data['status'],
                            'program_status': program_data['status']
                        })

                    comparison_identity_results.append({
                        'national_id': national_id,
                        'excel_name': excel_data['name'],
                        'program_name': program_data['name'],
                        'excel_status': excel_data['status'],
                        'excel_reason': excel_data['reason'],
                        'program_status': program_data['status'],
                        'program_reason': program_data['reason'] or '',
                        'course_name': program_data['course_name'],
                        'course_code': program_data['course_code'],
                        'is_match': is_match,
                        'status_icon': status_icon,
                        'color': color
                    })
                else:
                    # Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Excel ÙÙ‚Ø·
                    not_in_program.append({
                        'national_id': national_id,
                        'name': excel_data['name'],
                        'status': excel_data['status'],
                        'reason': excel_data['reason']
                    })

                # ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                progress_bar['value'] = i + 1
                audit_window.update()

            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„ÙŠØ³ÙˆØ§ ÙÙŠ Excel
            for national_id, program_data in program_rejected.items():
                if national_id not in excel_rejected:
                    not_in_excel.append({
                        'national_id': national_id,
                        'name': program_data['name'],
                        'status': program_data['status'],
                        'reason': program_data['reason'],
                        'course_name': program_data['course_name'],
                        'course_code': program_data['course_code']
                    })

            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
            total_excel_rejected = len(excel_rejected)
            total_program_rejected = len(program_rejected)
            matched_count = len(matched_list)
            not_in_program_count = len(not_in_program)
            not_in_excel_count = len(not_in_excel)

            # Ø¥Ø²Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            progress_card.destroy()

            # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
            display_identity_results(
                total_excel_rejected,
                total_program_rejected,
                matched_count,
                not_in_program_count,
                not_in_excel_count,
                matched_list,
                not_in_program,
                not_in_excel
            )

        # ================== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==================
        def display_identity_results(total_excel, total_program, matched_count,
                                     not_in_program_count, not_in_excel_count,
                                     matched_list, not_in_program, not_in_excel):
            """Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©"""

            # Ø¨Ø·Ø§Ù‚Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            summary_card = tk.Frame(identity_tab, bg="white", relief=tk.FLAT, bd=0)
            summary_card.pack(fill=tk.X, pady=15, padx=20)

            summary_content = tk.Frame(summary_card, bg="white", padx=40, pady=30)
            summary_content.pack(fill=tk.BOTH)

            # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            title_frame = tk.Frame(summary_content, bg="white")
            title_frame.pack(pady=(0, 20))

            tk.Label(
                title_frame,
                text="ğŸ“Š",
                font=("Arial", 24),
                bg="white",
                fg="#1a237e"
            ).pack(side=tk.RIGHT, padx=10)

            tk.Label(
                title_frame,
                text="Ù†ØªØ§Ø¦Ø¬ Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ†",
                font=("Tajawal", 20, "bold"),
                bg="white",
                fg="#1a237e"
            ).pack(side=tk.RIGHT)

            # Ø®Ø· ÙØ§ØµÙ„
            tk.Frame(summary_content, bg="#e0e0e0", height=1).pack(fill=tk.X, pady=15)

            # Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            stats_container = tk.Frame(summary_content, bg="white")
            stats_container.pack()

            # Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
            stats_grid = tk.Frame(stats_container, bg="white")
            stats_grid.pack()

            # Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
            row1 = tk.Frame(stats_grid, bg="white")
            row1.pack(pady=10)

            cards_data = [
                ("Ù…Ø±ÙÙˆØ¶ÙŠÙ† ÙÙŠ Excel", total_excel, "#fff3e0", "#ff9800"),
                ("Ù…Ø±ÙÙˆØ¶ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", total_program, "#e3f2fd", "#1976d2"),
                ("Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†", matched_count, "#e8f5e9", "#2e7d32")
            ]

            for label, value, bg_color, fg_color in cards_data:
                card = tk.Frame(row1, bg=bg_color, relief=tk.FLAT, width=180, height=100)
                card.pack(side=tk.LEFT, padx=10)
                card.pack_propagate(False)

                tk.Label(card, text=label, font=("Tajawal", 11), bg=bg_color, fg=fg_color).pack(pady=(15, 5))
                tk.Label(card, text=str(value), font=("Tajawal", 22, "bold"), bg=bg_color, fg=fg_color).pack()

            # Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ
            row2 = tk.Frame(stats_grid, bg="white")
            row2.pack(pady=10)

            cards_data2 = [
                ("ÙÙŠ Excel ÙˆÙ„ÙŠØ³ÙˆØ§ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", not_in_program_count, "#ffebee", "#d32f2f"),
                ("ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ„ÙŠØ³ÙˆØ§ ÙÙŠ Excel", not_in_excel_count, "#f3e5f5", "#9c27b0")
            ]

            for label, value, bg_color, fg_color in cards_data2:
                card = tk.Frame(row2, bg=bg_color, relief=tk.FLAT, width=270, height=100)
                card.pack(side=tk.LEFT, padx=10)
                card.pack_propagate(False)

                tk.Label(card, text=label, font=("Tajawal", 11), bg=bg_color, fg=fg_color).pack(pady=(15, 5))
                tk.Label(card, text=str(value), font=("Tajawal", 22, "bold"), bg=bg_color, fg=fg_color).pack()

            # Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø®ØªÙ„Ø§Ù
            if not_in_program_count > 0 or not_in_excel_count > 0:
                alert_frame = tk.Frame(summary_content, bg="#fff3e0", relief=tk.FLAT)
                alert_frame.pack(fill=tk.X, pady=15, padx=20)

                inner = tk.Frame(alert_frame, bg="#fff3e0", padx=20, pady=15)
                inner.pack()

                tk.Label(
                    inner,
                    text="âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                    font=("Tajawal", 14, "bold"),
                    bg="#fff3e0",
                    fg="#ff9800"
                ).pack()

                if not_in_excel_count > 0:
                    tk.Label(
                        inner,
                        text=f"â€¢ ÙŠÙˆØ¬Ø¯ {not_in_excel_count} Ù…Ø±ÙÙˆØ¶ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ù…Ù„Ù Excel",
                        font=("Tajawal", 12),
                        bg="#fff3e0",
                        fg="#ff9800"
                    ).pack(pady=3)

                if not_in_program_count > 0:
                    tk.Label(
                        inner,
                        text=f"â€¢ ÙŠÙˆØ¬Ø¯ {not_in_program_count} Ù…Ø±ÙÙˆØ¶ ÙÙŠ Excel ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
                        font=("Tajawal", 12),
                        bg="#fff3e0",
                        fg="#ff9800"
                    ).pack(pady=3)

            # Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨Ø§Øª
            if matched_list or not_in_program or not_in_excel:
                details_card = tk.Frame(identity_tab, bg="white", relief=tk.FLAT, bd=0)
                details_card.pack(fill=tk.BOTH, expand=True, pady=15, padx=20)

                details_content = tk.Frame(details_card, bg="white", padx=30, pady=25)
                details_content.pack(fill=tk.BOTH, expand=True)

                notebook = ttk.Notebook(details_content)
                notebook.pack(fill=tk.BOTH, expand=True)

                # ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†
                if matched_list:
                    matched_tab = tk.Frame(notebook, bg="white")
                    notebook.add(matched_tab, text=f"Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ† ({len(matched_list)})")

                    # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†
                    matched_tree_frame = tk.Frame(matched_tab, bg="white")
                    matched_tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

                    columns = ("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø§Ø³Ù…", "Ø­Ø§Ù„Ø© Excel", "Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬")
                    matched_tree = ttk.Treeview(matched_tree_frame, columns=columns, show="headings", height=15)

                    matched_tree.column("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", width=150, anchor="center")
                    matched_tree.column("Ø§Ù„Ø§Ø³Ù…", width=250, anchor="center")
                    matched_tree.column("Ø­Ø§Ù„Ø© Excel", width=150, anchor="center")
                    matched_tree.column("Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", width=150, anchor="center")

                    for col in columns:
                        matched_tree.heading(col, text=col)

                    matched_tree.tag_configure('matched', background='#e8f5e9')

                    for item in matched_list:
                        matched_tree.insert("", tk.END, values=(
                            item['national_id'],
                            item['name'],
                            item['excel_status'],
                            item['program_status']
                        ), tags=('matched',))

                    scrollbar = ttk.Scrollbar(matched_tree_frame, orient="vertical", command=matched_tree.yview)
                    matched_tree.configure(yscrollcommand=scrollbar.set)
                    matched_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
                    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

                # ØªØ¨ÙˆÙŠØ¨ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                if not_in_program:
                    not_in_prog_tab = tk.Frame(notebook, bg="white")
                    notebook.add(not_in_prog_tab, text=f"ÙÙŠ Excel ÙÙ‚Ø· ({len(not_in_program)})")

                    # Ø¬Ø¯ÙˆÙ„
                    prog_tree_frame = tk.Frame(not_in_prog_tab, bg="white")
                    prog_tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

                    columns = ("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„Ø³Ø¨Ø¨")
                    prog_tree = ttk.Treeview(prog_tree_frame, columns=columns, show="headings", height=15)

                    prog_tree.column("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", width=150, anchor="center")
                    prog_tree.column("Ø§Ù„Ø§Ø³Ù…", width=250, anchor="center")
                    prog_tree.column("Ø§Ù„Ø­Ø§Ù„Ø©", width=150, anchor="center")
                    prog_tree.column("Ø§Ù„Ø³Ø¨Ø¨", width=250, anchor="center")

                    for col in columns:
                        prog_tree.heading(col, text=col)

                    prog_tree.tag_configure('missing', background='#ffebee')

                    for item in not_in_program:
                        prog_tree.insert("", tk.END, values=(
                            item['national_id'],
                            item['name'],
                            item['status'],
                            item['reason']
                        ), tags=('missing',))

                    scrollbar = ttk.Scrollbar(prog_tree_frame, orient="vertical", command=prog_tree.yview)
                    prog_tree.configure(yscrollcommand=scrollbar.set)
                    prog_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
                    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

                # ØªØ¨ÙˆÙŠØ¨ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Excel
                if not_in_excel:
                    not_in_excel_tab = tk.Frame(notebook, bg="white")
                    notebook.add(not_in_excel_tab, text=f"ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙ‚Ø· ({len(not_in_excel)})")

                    # Ø¬Ø¯ÙˆÙ„
                    excel_tree_frame = tk.Frame(not_in_excel_tab, bg="white")
                    excel_tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

                    columns = ("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø­Ø§Ù„Ø©", "Ø§Ù„Ø³Ø¨Ø¨", "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©")
                    excel_tree = ttk.Treeview(excel_tree_frame, columns=columns, show="headings", height=15)

                    excel_tree.column("Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", width=130, anchor="center")
                    excel_tree.column("Ø§Ù„Ø§Ø³Ù…", width=200, anchor="center")
                    excel_tree.column("Ø§Ù„Ø­Ø§Ù„Ø©", width=120, anchor="center")
                    excel_tree.column("Ø§Ù„Ø³Ø¨Ø¨", width=200, anchor="center")
                    excel_tree.column("Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", width=200, anchor="center")

                    for col in columns:
                        excel_tree.heading(col, text=col)

                    excel_tree.tag_configure('missing', background='#f3e5f5')

                    for item in not_in_excel:
                        excel_tree.insert("", tk.END, values=(
                            item['national_id'],
                            item['name'],
                            item['status'],
                            item['reason'] if item['reason'] else '',
                            item['course_name']
                        ), tags=('missing',))

                    scrollbar = ttk.Scrollbar(excel_tree_frame, orient="vertical", command=excel_tree.yview)
                    excel_tree.configure(yscrollcommand=scrollbar.set)
                    excel_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
                    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        import_identity_btn = tk.Button(
            buttons_identity_frame,
            text="ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel",
            font=("Tajawal", 12, "bold"),
            bg="#1a237e",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=import_identity_file
        )
        import_identity_btn.pack(side=tk.RIGHT, padx=8)

        template_identity_btn = tk.Button(
            buttons_identity_frame,
            text="ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº",
            font=("Tajawal", 12, "bold"),
            bg="#607d8b",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=download_identity_template
        )
        template_identity_btn.pack(side=tk.RIGHT, padx=8)

        validate_identity_btn = tk.Button(
            buttons_identity_frame,
            text="âœ“ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©",
            font=("Tajawal", 12, "bold"),
            bg="#9e9e9e",
            fg="white",
            padx=30,
            pady=12,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=perform_identity_validation,
            state=tk.DISABLED
        )
        validate_identity_btn.pack(side=tk.RIGHT, padx=8)

        import_identity_info = tk.Label(
            import_identity_content,
            text="Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…Ù„Ù Ø¨Ø¹Ø¯",
            font=("Tajawal", 11),
            bg="white",
            fg="#9e9e9e"
        )
        import_identity_info.pack(pady=(20, 0))

        # ÙˆØ¶Ø¹ Canvas ÙˆØ§Ù„Ø´Ø±ÙŠØ·
        main_canvas.pack(side="left", fill="both", expand=True)
        main_scrollbar_y.pack(side="right", fill="y")

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
        status_bar = tk.Frame(audit_window, bg="#263238", height=40)
        status_bar.pack(side=tk.BOTTOM, fill=tk.X)
        status_bar.pack_propagate(False)

        tk.Label(
            status_bar,
            text="Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø¬Ø§Ù‡Ø²",
            font=("Tajawal", 11),
            bg="#263238",
            fg="white"
        ).pack(expand=True)

    def _create_programs_tables(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            with self.db_conn:
                # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬
                self.db_conn.execute("""
                    CREATE TABLE IF NOT EXISTS programs (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        program_name TEXT NOT NULL,
                        program_description TEXT,
                        created_date TEXT,
                        created_by TEXT
                    )
                """)

                # Ø¬Ø¯ÙˆÙ„ Ø±Ø¨Ø· Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø¨Ø§Ù„Ø¯ÙˆØ±Ø§Øª
                self.db_conn.execute("""
                    CREATE TABLE IF NOT EXISTS program_courses (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        program_id INTEGER,
                        course_id INTEGER,
                        FOREIGN KEY (program_id) REFERENCES programs(id),
                        FOREIGN KEY (course_id) REFERENCES courses(id)
                    )
                """)

                self.db_conn.commit()
        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬: {e}")
